{
  "task_id": "670be485f9a4",
  "prompt": "You are planning a software project called \"improved docs for agent coding\".\n\n## Project Goal\n\nyour task is to make a plan to improve the docs/ and claude.md to make working on the agent system easier. i particularly want good feature docs so that when working on a feature its easy for an agent to get the context it needs.\n\n## Your Task\n\n1. Analyze the repository (if it exists) to understand the current codebase.\n2. Create a detailed design document covering architecture, key decisions, and implementation approach.\n3. Break the project into phases, each with concrete, implementable tasks.\n4. Each task should have a clear title, description, and acceptance criteria.\n5. Write the plan to PLAN.md in the workspace.\n\nFocus on creating an actionable, well-structured plan that can be executed incrementally.",
  "repo_url": "https://github.com/danvaneijck/my_agent",
  "branch": "project/improved-docs-for-agent-coding",
  "source_branch": "main",
  "workspace": "/tmp/claude_tasks/670be485f9a4",
  "log_file": "/tmp/claude_tasks/670be485f9a4/task_670be485f9a4.log",
  "status": "awaiting_input",
  "mode": "plan",
  "auto_push": false,
  "parent_task_id": null,
  "user_id": "877b6f0c-6435-4f5d-b93e-aa52e4784456",
  "created_at": "2026-02-15T23:21:57.138078+00:00",
  "started_at": "2026-02-15T23:21:57.138596+00:00",
  "completed_at": "2026-02-15T23:25:53.338830+00:00",
  "heartbeat": "2026-02-15T23:25:27.145266+00:00",
  "elapsed_seconds": 236.2,
  "result": {
    "json_output": [
      {
        "type": "system",
        "subtype": "init",
        "cwd": "/tmp/claude_tasks/670be485f9a4",
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "tools": [
          "Task",
          "TaskOutput",
          "Bash",
          "Glob",
          "Grep",
          "ExitPlanMode",
          "Read",
          "Edit",
          "Write",
          "NotebookEdit",
          "WebFetch",
          "TodoWrite",
          "WebSearch",
          "TaskStop",
          "AskUserQuestion",
          "Skill",
          "EnterPlanMode",
          "ToolSearch"
        ],
        "mcp_servers": [],
        "model": "claude-sonnet-4-5-20250929",
        "permissionMode": "bypassPermissions",
        "slash_commands": [
          "debug",
          "compact",
          "context",
          "cost",
          "init",
          "pr-comments",
          "release-notes",
          "review",
          "security-review",
          "insights"
        ],
        "apiKeySource": "none",
        "claude_code_version": "2.1.42",
        "output_style": "default",
        "agents": [
          "Bash",
          "general-purpose",
          "statusline-setup",
          "Explore",
          "Plan"
        ],
        "skills": [
          "debug"
        ],
        "plugins": [],
        "uuid": "e3d1cec9-48d3-4316-b1bd-6e8d66d88840",
        "fast_mode_state": "off"
      },
      {
        "type": "assistant",
        "message": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_0153t3tk49CRwXrMeE25fmTg",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "text",
              "text": "I'll analyze the current documentation structure and create a comprehensive plan to improve the docs for easier agent-based development."
            }
          ],
          "stop_reason": null,
          "stop_sequence": null,
          "usage": {
            "input_tokens": 3,
            "cache_creation_input_tokens": 13123,
            "cache_read_input_tokens": 13688,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 13123
            },
            "output_tokens": 5,
            "service_tier": "standard",
            "inference_geo": "not_available"
          },
          "context_management": null
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "9811afa6-46fd-4aba-bcda-1e14f36ae68f"
      },
      {
        "type": "assistant",
        "message": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_0153t3tk49CRwXrMeE25fmTg",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "tool_use",
              "id": "toolu_01LkvtUatYaVXT8DVdnpZZ1z",
              "name": "TodoWrite",
              "input": {
                "todos": [
                  {
                    "content": "Analyze current documentation structure",
                    "activeForm": "Analyzing current documentation structure",
                    "status": "in_progress"
                  },
                  {
                    "content": "Review existing module documentation",
                    "activeForm": "Reviewing existing module documentation",
                    "status": "pending"
                  },
                  {
                    "content": "Identify documentation gaps and pain points",
                    "activeForm": "Identifying documentation gaps and pain points",
                    "status": "pending"
                  },
                  {
                    "content": "Create comprehensive implementation plan",
                    "activeForm": "Creating comprehensive implementation plan",
                    "status": "pending"
                  }
                ]
              },
              "caller": {
                "type": "direct"
              }
            }
          ],
          "stop_reason": null,
          "stop_sequence": null,
          "usage": {
            "input_tokens": 3,
            "cache_creation_input_tokens": 13123,
            "cache_read_input_tokens": 13688,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 13123
            },
            "output_tokens": 5,
            "service_tier": "standard",
            "inference_geo": "not_available"
          },
          "context_management": null
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "082a7ba4-5871-4cd0-9cc6-4973755df03f"
      },
      {
        "type": "user",
        "message": {
          "role": "user",
          "content": [
            {
              "tool_use_id": "toolu_01LkvtUatYaVXT8DVdnpZZ1z",
              "type": "tool_result",
              "content": "Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"
            }
          ]
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "e600372e-b0bb-416f-9016-68762d51706e",
        "tool_use_result": {
          "oldTodos": [],
          "newTodos": [
            {
              "content": "Analyze current documentation structure",
              "status": "in_progress",
              "activeForm": "Analyzing current documentation structure"
            },
            {
              "content": "Review existing module documentation",
              "status": "pending",
              "activeForm": "Reviewing existing module documentation"
            },
            {
              "content": "Identify documentation gaps and pain points",
              "status": "pending",
              "activeForm": "Identifying documentation gaps and pain points"
            },
            {
              "content": "Create comprehensive implementation plan",
              "status": "pending",
              "activeForm": "Creating comprehensive implementation plan"
            }
          ]
        }
      },
      {
        "type": "assistant",
        "message": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_01KMdqE2SLvjLHSWBuXWzNw9",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "text",
              "text": "Let me start by exploring the current documentation structure and understanding what exists."
            }
          ],
          "stop_reason": null,
          "stop_sequence": null,
          "usage": {
            "input_tokens": 6,
            "cache_creation_input_tokens": 13353,
            "cache_read_input_tokens": 13682,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 13353
            },
            "output_tokens": 1,
            "service_tier": "standard",
            "inference_geo": "not_available"
          },
          "context_management": null
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "5910adb0-8c79-418e-bdc6-5f21e3ebde6f"
      },
      {
        "type": "assistant",
        "message": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_01KMdqE2SLvjLHSWBuXWzNw9",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "tool_use",
              "id": "toolu_01XoZx9REWDLjNwnrjjdEYzb",
              "name": "Bash",
              "input": {
                "command": "find . -name \"*.md\" -type f | head -30",
                "description": "Find all markdown documentation files"
              },
              "caller": {
                "type": "direct"
              }
            }
          ],
          "stop_reason": null,
          "stop_sequence": null,
          "usage": {
            "input_tokens": 6,
            "cache_creation_input_tokens": 13353,
            "cache_read_input_tokens": 13682,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 13353
            },
            "output_tokens": 1,
            "service_tier": "standard",
            "inference_geo": "not_available"
          },
          "context_management": null
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "0e515016-1765-41d6-b09f-e651b5b3d377"
      },
      {
        "type": "user",
        "message": {
          "role": "user",
          "content": [
            {
              "tool_use_id": "toolu_01XoZx9REWDLjNwnrjjdEYzb",
              "type": "tool_result",
              "content": "./agent/modules/weather/README.md\n./agent/docs/modules/scheduler.md\n./agent/docs/modules/research.md\n./agent/docs/modules/overview.md\n./agent/docs/modules/renpho_biometrics.md\n./agent/docs/modules/knowledge.md\n./agent/docs/modules/injective.md\n./agent/docs/modules/code_executor.md\n./agent/docs/modules/file_manager.md\n./agent/docs/modules/atlassian.md\n./agent/docs/modules/location.md\n./agent/docs/modules/git_platform.md\n./agent/docs/modules/myfitnesspal.md\n./agent/docs/modules/deployer.md\n./agent/docs/modules/claude_code.md\n./agent/docs/modules/project_planner.md\n./agent/docs/modules/garmin.md\n./agent/docs/ADDING_MODULES.md\n./agent/docs/portal.md\n./CLAUDE.md\n./README.md",
              "is_error": false
            }
          ]
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "c2637d00-92d0-4a29-8f57-6cfed084c599",
        "tool_use_result": {
          "stdout": "./agent/modules/weather/README.md\n./agent/docs/modules/scheduler.md\n./agent/docs/modules/research.md\n./agent/docs/modules/overview.md\n./agent/docs/modules/renpho_biometrics.md\n./agent/docs/modules/knowledge.md\n./agent/docs/modules/injective.md\n./agent/docs/modules/code_executor.md\n./agent/docs/modules/file_manager.md\n./agent/docs/modules/atlassian.md\n./agent/docs/modules/location.md\n./agent/docs/modules/git_platform.md\n./agent/docs/modules/myfitnesspal.md\n./agent/docs/modules/deployer.md\n./agent/docs/modules/claude_code.md\n./agent/docs/modules/project_planner.md\n./agent/docs/modules/garmin.md\n./agent/docs/ADDING_MODULES.md\n./agent/docs/portal.md\n./CLAUDE.md\n./README.md",
          "stderr": "",
          "interrupted": false,
          "isImage": false,
          "noOutputExpected": false
        }
      },
      {
        "type": "assistant",
        "message": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_01KMdqE2SLvjLHSWBuXWzNw9",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "tool_use",
              "id": "toolu_01M4He6eBhaqRa3iKyfZ43Ys",
              "name": "Bash",
              "input": {
                "command": "ls -la agent/docs/ 2>/dev/null || echo \"docs directory not found at agent/docs\"",
                "description": "List docs directory structure"
              },
              "caller": {
                "type": "direct"
              }
            }
          ],
          "stop_reason": null,
          "stop_sequence": null,
          "usage": {
            "input_tokens": 6,
            "cache_creation_input_tokens": 13353,
            "cache_read_input_tokens": 13682,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 13353
            },
            "output_tokens": 1,
            "service_tier": "standard",
            "inference_geo": "not_available"
          },
          "context_management": null
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "00a38d00-b16e-40fe-b5ad-05be8f930ab5"
      },
      {
        "type": "user",
        "message": {
          "role": "user",
          "content": [
            {
              "tool_use_id": "toolu_01M4He6eBhaqRa3iKyfZ43Ys",
              "type": "tool_result",
              "content": "total 40\ndrwxr-xr-x  3 claude claude  4096 Feb 15 23:21 .\ndrwxr-xr-x 12 claude claude  4096 Feb 15 23:21 ..\n-rw-r--r--  1 claude claude 15215 Feb 15 23:21 ADDING_MODULES.md\ndrwxr-xr-x  2 claude claude  4096 Feb 15 23:21 modules\n-rw-r--r--  1 claude claude  9055 Feb 15 23:21 portal.md",
              "is_error": false
            }
          ]
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "d558e675-807a-48a0-9de1-367bf778b236",
        "tool_use_result": {
          "stdout": "total 40\ndrwxr-xr-x  3 claude claude  4096 Feb 15 23:21 .\ndrwxr-xr-x 12 claude claude  4096 Feb 15 23:21 ..\n-rw-r--r--  1 claude claude 15215 Feb 15 23:21 ADDING_MODULES.md\ndrwxr-xr-x  2 claude claude  4096 Feb 15 23:21 modules\n-rw-r--r--  1 claude claude  9055 Feb 15 23:21 portal.md",
          "stderr": "",
          "interrupted": false,
          "isImage": false,
          "noOutputExpected": false
        }
      },
      {
        "type": "assistant",
        "message": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_01KMdqE2SLvjLHSWBuXWzNw9",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "tool_use",
              "id": "toolu_01QtNZt3MuZt4rWjRWEDY4UA",
              "name": "Read",
              "input": {
                "file_path": "/tmp/claude_tasks/670be485f9a4/CLAUDE.md"
              },
              "caller": {
                "type": "direct"
              }
            }
          ],
          "stop_reason": null,
          "stop_sequence": null,
          "usage": {
            "input_tokens": 6,
            "cache_creation_input_tokens": 13353,
            "cache_read_input_tokens": 13682,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 13353
            },
            "output_tokens": 1,
            "service_tier": "standard",
            "inference_geo": "not_available"
          },
          "context_management": null
        },
        "parent_tool_use_id": null,
        "session_id": "35c5c018-5c2e-45db-b550-126fc370d3fa",
        "uuid": "6f5f3720-16e6-4456-ad6e-a41636f0eacb"
      }
    ],
    "raw_text": "Cloning into '.'...\nYour branch is up to date with 'origin/main'.\n{\"type\":\"user\",\"message\":{\"role\":\"user\",\"content\":[{\"tool_use_id\":\"toolu_01QtNZt3MuZt4rWjRWEDY4UA\",\"type\":\"tool_result\",\"content\":\"     1\u2192# AI Agent System \u2014 Developer Guide\\n     2\u2192\\n     3\u2192## Quick Reference\\n     4\u2192\\n     5\u2192```\\n     6\u2192Project root:   /home/user/my_agent\\n     7\u2192App code:       /home/user/my_agent/agent/\\n     8\u2192Compose file:   agent/docker-compose.yml\\n     9\u2192Shared package: agent/shared/shared/\\n    10\u2192Models:         agent/shared/shared/models/\\n    11\u2192Schemas:        agent/shared/shared/schemas/\\n    12\u2192Core service:   agent/core/\\n    13\u2192Modules:        agent/modules/<name>/\\n    14\u2192Bots:           agent/comms/<platform>_bot/\\n    15\u2192Migrations:     agent/alembic/versions/\\n    16\u2192Makefile:       Makefile (top-level, wraps docker compose)\\n    17\u2192```\\n    18\u2192\\n    19\u2192## Architecture Overview\\n    20\u2192\\n    21\u2192```\\n    22\u2192 Discord / Telegram / Slack\\n    23\u2192         \u2502\\n    24\u2192    Communication Layer (bots)\\n    25\u2192         \u2502  POST /message (IncomingMessage \u2192 AgentResponse)\\n    26\u2192         \u25bc\\n    27\u2192    Core Orchestrator (FastAPI :8000)\\n    28\u2192    \u251c\u2500\u2500 Agent Loop (reason/act/observe cycle, up to 10 iterations)\\n    29\u2192    \u251c\u2500\u2500 LLM Router (Anthropic, OpenAI, Google \u2014 with fallback chain)\\n    30\u2192    \u251c\u2500\u2500 Context Builder (system prompt + memories + history)\\n    31\u2192    \u2514\u2500\u2500 Tool Registry (discovers modules via GET /manifest)\\n    32\u2192         \u2502  POST /execute (ToolCall \u2192 ToolResult)\\n    33\u2192         \u25bc\\n    34\u2192    Module Layer (independent FastAPI microservices)\\n    35\u2192    \u251c\u2500\u2500 research          \u2014 web search, scraping, news\\n    36\u2192    \u251c\u2500\u2500 file_manager      \u2014 file CRUD on MinIO + DB records\\n    37\u2192    \u251c\u2500\u2500 code_executor     \u2014 sandboxed Python/shell execution\\n    38\u2192    \u251c\u2500\u2500 knowledge         \u2014 persistent per-user memory with embeddings\\n    39\u2192    \u251c\u2500\u2500 atlassian         \u2014 Jira + Confluence integration\\n    40\u2192    \u251c\u2500\u2500 claude_code       \u2014 coding tasks via Claude Code CLI in Docker\\n    41\u2192    \u251c\u2500\u2500 deployer          \u2014 deploy projects to live URLs\\n    42\u2192    \u251c\u2500\u2500 scheduler         \u2014 background job monitoring + notifications\\n    43\u2192    \u251c\u2500\u2500 garmin            \u2014 Garmin Connect health/fitness data\\n    44\u2192    \u251c\u2500\u2500 renpho_biometrics \u2014 Renpho smart scale body composition\\n    45\u2192    \u251c\u2500\u2500 location          \u2014 OwnTracks geofence reminders + tracking\\n    46\u2192    \u251c\u2500\u2500 project_planner   \u2014 project planning, tracking + autonomous execution\\n    47\u2192    \u2514\u2500\u2500 injective         \u2014 blockchain trading (scaffold)\\n    48\u2192\\n    49\u2192 Infrastructure: PostgreSQL+pgvector \u2502 Redis \u2502 MinIO (S3)\\n    50\u2192```\\n    51\u2192\\n    52\u2192All services communicate over the `agent-net` Docker bridge network. Services are containerized with Python 3.12-slim base images.\\n    53\u2192\\n    54\u2192## Module Documentation\\n    55\u2192\\n    56\u2192Detailed per-module docs live in `agent/docs/modules/`:\\n    57\u2192\\n    58\u2192- [Module System Overview](agent/docs/modules/overview.md) \u2014 discovery, routing, permissions, workflow chaining\\n    59\u2192- [research](agent/docs/modules/research.md) \u2014 web search, news, scraping, summarization\\n    60\u2192- [file_manager](agent/docs/modules/file_manager.md) \u2014 file CRUD on MinIO + DB records\\n    61\u2192- [code_executor](agent/docs/modules/code_executor.md) \u2014 sandboxed Python/shell execution\\n    62\u2192- [knowledge](agent/docs/modules/knowledge.md) \u2014 semantic memory with pgvector embeddings\\n    63\u2192- [atlassian](agent/docs/modules/atlassian.md) \u2014 Jira + Confluence integration\\n    64\u2192- [claude_code](agent/docs/modules/claude_code.md) \u2014 coding tasks via Claude Code CLI in Docker\\n    65\u2192- [deployer](agent/docs/modules/deployer.md) \u2014 deploy projects to live URLs\\n    66\u2192- [scheduler](agent/docs/modules/scheduler.md) \u2014 background jobs + workflow chaining\\n    67\u2192- [garmin](agent/docs/modules/garmin.md) \u2014 Garmin Connect health/fitness data\\n    68\u2192- [renpho_biometrics](agent/docs/modules/renpho_biometrics.md) \u2014 Renpho smart scale body composition\\n    69\u2192- [location](agent/docs/modules/location.md) \u2014 OwnTracks geofence reminders + tracking\\n    70\u2192- [git_platform](agent/docs/modules/git_platform.md) \u2014 GitHub/Bitbucket repos, issues, PRs, CI\\n    71\u2192- [myfitnesspal](agent/docs/modules/myfitnesspal.md) \u2014 nutrition and meal tracking\\n    72\u2192- [project_planner](agent/docs/modules/project_planner.md) \u2014 project planning, tracking + autonomous execution\\n    73\u2192- [injective](agent/docs/modules/injective.md) \u2014 blockchain spot and perpetual trading\\n    74\u2192\\n    75\u2192## Tech Stack\\n    76\u2192\\n    77\u2192| Layer | Technology |\\n    78\u2192|---|---|\\n    79\u2192| Language | Python 3.12 |\\n    80\u2192| Web framework | FastAPI + uvicorn |\\n    81\u2192| Database | PostgreSQL 16 with pgvector extension |\\n    82\u2192| ORM | SQLAlchemy 2.0 (async, via asyncpg) |\\n    83\u2192| Migrations | Alembic |\\n    84\u2192| Cache | Redis 7 |\\n    85\u2192| File storage | MinIO (S3-compatible) |\\n    86\u2192| LLM SDKs | `anthropic`, `openai`, `google-genai` |\\n    87\u2192| Logging | structlog (JSON output) |\\n    88\u2192| Config | pydantic-settings v2 |\\n    89\u2192| Container orchestration | Docker Compose |\\n    90\u2192| Admin dashboard | Streamlit |\\n    91\u2192\\n    92\u2192## Database Schema\\n    93\u2192\\n    94\u2192All tables use UUID primary keys and `DateTime(timezone=True)` for timestamps.\\n    95\u2192\\n    96\u2192```\\n    97\u2192users\\n    98\u2192  id                    UUID PK\\n    99\u2192  permission_level      str        \u2014 \\\"guest\\\" | \\\"user\\\" | \\\"admin\\\" | \\\"owner\\\"\\n   100\u2192  token_budget_monthly  int | null \u2014 null = unlimited\\n   101\u2192  tokens_used_this_month int\\n   102\u2192  budget_reset_at       datetime(tz)\\n   103\u2192  created_at            datetime(tz)\\n   104\u2192\\n   105\u2192user_platform_links\\n   106\u2192  id                    UUID PK\\n   107\u2192  user_id               UUID FK \u2192 users.id\\n   108\u2192  platform              str        \u2014 \\\"discord\\\" | \\\"telegram\\\" | \\\"slack\\\"\\n   109\u2192  platform_user_id      str\\n   110\u2192  platform_username     str | null\\n   111\u2192  UNIQUE(platform, platform_user_id)\\n   112\u2192\\n   113\u2192personas\\n   114\u2192  id                    UUID PK\\n   115\u2192  name                  str\\n   116\u2192  system_prompt         text\\n   117\u2192  platform              str | null   \u2014 scope to a platform\\n   118\u2192  platform_server_id    str | null   \u2014 scope to a server/guild\\n   119\u2192  allowed_modules       str (JSON)   \u2014 e.g. '[\\\"research\\\",\\\"file_manager\\\"]'\\n   120\u2192  default_model         str | null\\n   121\u2192  max_tokens_per_request int         \u2014 default 4000\\n   122\u2192  is_default            bool\\n   123\u2192  created_at            datetime(tz)\\n   124\u2192\\n   125\u2192conversations\\n   126\u2192  id                    UUID PK\\n   127\u2192  user_id               UUID FK \u2192 users.id\\n   128\u2192  persona_id            UUID FK \u2192 personas.id (nullable)\\n   129\u2192  platform              str\\n   130\u2192  platform_channel_id   str\\n   131\u2192  platform_thread_id    str | null\\n   132\u2192  started_at            datetime(tz)\\n   133\u2192  last_active_at        datetime(tz)\\n   134\u2192  is_summarized         bool\\n   135\u2192\\n   136\u2192messages\\n   137\u2192  id                    UUID PK\\n   138\u2192  conversation_id       UUID FK \u2192 conversations.id\\n   139\u2192  role                  str        \u2014 \\\"user\\\" | \\\"assistant\\\" | \\\"system\\\" | \\\"tool_call\\\" | \\\"tool_result\\\"\\n   140\u2192  content               text\\n   141\u2192  token_count           int | null\\n   142\u2192  model_used            str | null\\n   143\u2192  created_at            datetime(tz)\\n   144\u2192\\n   145\u2192memory_summaries\\n   146\u2192  id                    UUID PK\\n   147\u2192  user_id               UUID FK \u2192 users.id\\n   148\u2192  conversation_id       UUID FK \u2192 conversations.id (nullable)\\n   149\u2192  summary               text\\n   150\u2192  embedding             Vector(1536)\\n   151\u2192  created_at            datetime(tz)\\n   152\u2192\\n   153\u2192token_logs\\n   154\u2192  id                    UUID PK\\n   155\u2192  user_id               UUID FK \u2192 users.id\\n   156\u2192  conversation_id       UUID FK \u2192 conversations.id\\n   157\u2192  model                 str\\n   158\u2192  input_tokens          int\\n   159\u2192  output_tokens         int\\n   160\u2192  cost_estimate         float | null\\n   161\u2192  created_at            datetime(tz)\\n   162\u2192\\n   163\u2192file_records\\n   164\u2192  id                    UUID PK\\n   165\u2192  user_id               UUID FK \u2192 users.id\\n   166\u2192  filename              str\\n   167\u2192  minio_key             str        \u2014 path within MinIO bucket\\n   168\u2192  mime_type             str | null\\n   169\u2192  size_bytes            int | null\\n   170\u2192  public_url            str\\n   171\u2192  created_at            datetime(tz)\\n   172\u2192\\n   173\u2192scheduled_jobs\\n   174\u2192  id                    UUID PK\\n   175\u2192  user_id               UUID FK \u2192 users.id\\n   176\u2192  conversation_id       UUID FK \u2192 conversations.id (nullable)\\n   177\u2192  platform              str\\n   178\u2192  platform_channel_id   str\\n   179\u2192  platform_thread_id    str | null\\n   180\u2192  job_type              str        \u2014 \\\"poll_module\\\" | \\\"delay\\\" | \\\"poll_url\\\"\\n   181\u2192  check_config          JSON\\n   182\u2192  interval_seconds      int        \u2014 default 30\\n   183\u2192  max_attempts          int        \u2014 default 120\\n   184\u2192  attempts              int        \u2014 default 0\\n   185\u2192  on_success_message    text\\n   186\u2192  on_failure_message    text | null\\n   187\u2192  status                str        \u2014 \\\"active\\\" | \\\"completed\\\" | \\\"failed\\\" | \\\"cancelled\\\"\\n   188\u2192  next_run_at           datetime(tz)\\n   189\u2192  created_at            datetime(tz)\\n   190\u2192  completed_at          datetime(tz) | null\\n   191\u2192\\n   192\u2192user_locations\\n   193\u2192  id                    UUID PK\\n   194\u2192  user_id               UUID FK \u2192 users.id (unique)\\n   195\u2192  latitude              float\\n   196\u2192  longitude             float\\n   197\u2192  accuracy_m            float | null\\n   198\u2192  speed_mps             float | null\\n   199\u2192  heading               float | null\\n   200\u2192  source                str        \u2014 default \\\"owntracks\\\"\\n   201\u2192  updated_at            datetime(tz)\\n   202\u2192  created_at            datetime(tz)\\n   203\u2192\\n   204\u2192location_reminders\\n   205\u2192  id                    UUID PK\\n   206\u2192  user_id               UUID FK \u2192 users.id\\n   207\u2192  conversation_id       UUID FK \u2192 conversations.id (nullable)\\n   208\u2192  message               str\\n   209\u2192  place_name            str\\n   210\u2192  place_lat             float\\n   211\u2192  place_lng             float\\n   212\u2192  radius_m              int        \u2014 default 150\\n   213\u2192  platform              str | null\\n   214\u2192  platform_channel_id   str | null\\n   215\u2192  platform_thread_id    str | null\\n   216\u2192  owntracks_rid         str        \u2014 OwnTracks region ID\\n   217\u2192  synced_to_device      bool       \u2014 default false\\n   218\u2192  status                str        \u2014 \\\"active\\\" | \\\"triggered\\\" | \\\"cancelled\\\" | \\\"expired\\\"\\n   219\u2192  triggered_at          datetime(tz) | null\\n   220\u2192  expires_at            datetime(tz) | null\\n   221\u2192  cooldown_until        datetime(tz) | null\\n   222\u2192  created_at            datetime(tz)\\n   223\u2192\\n   224\u2192user_named_places\\n   225\u2192  id                    UUID PK\\n   226\u2192  user_id               UUID FK \u2192 users.id\\n   227\u2192  name                  str\\n   228\u2192  latitude              float\\n   229\u2192  longitude             float\\n   230\u2192  address               str | null\\n   231\u2192  created_at            datetime(tz)\\n   232\u2192  UNIQUE(user_id, name)\\n   233\u2192\\n   234\u2192owntracks_credentials\\n   235\u2192  id                    UUID PK\\n   236\u2192  user_id               UUID FK \u2192 users.id\\n   237\u2192  username              str (unique)\\n   238\u2192  password_hash         str\\n   239\u2192  device_name           str | null\\n   240\u2192  is_active             bool       \u2014 default true\\n   241\u2192  last_seen_at          datetime(tz) | null\\n   242\u2192  created_at            datetime(tz)\\n   243\u2192\\n   244\u2192projects\\n   245\u2192  id                    UUID PK\\n   246\u2192  user_id               UUID FK \u2192 users.id\\n   247\u2192  name                  str\\n   248\u2192  description           text | null\\n   249\u2192  design_document       text | null       \u2014 full markdown design doc\\n   250\u2192  repo_owner            str | null\\n   251\u2192  repo_name             str | null\\n   252\u2192  default_branch        str               \u2014 default \\\"main\\\"\\n   253\u2192  auto_merge            bool              \u2014 default false\\n   254\u2192  status                str               \u2014 \\\"planning\\\" | \\\"active\\\" | \\\"paused\\\" | \\\"completed\\\" | \\\"archived\\\"\\n   255\u2192  created_at            datetime(tz)\\n   256\u2192  updated_at            datetime(tz)\\n   257\u2192  UNIQUE(user_id, name)\\n   258\u2192\\n   259\u2192project_phases\\n   260\u2192  id                    UUID PK\\n   261\u2192  project_id            UUID FK \u2192 projects.id (CASCADE)\\n   262\u2192  name                  str\\n   263\u2192  description           text | null\\n   264\u2192  order_index           int               \u2014 sort order within project\\n   265\u2192  status                str               \u2014 \\\"planned\\\" | \\\"in_progress\\\" | \\\"completed\\\"\\n   266\u2192  created_at            datetime(tz)\\n   267\u2192  updated_at            datetime(tz)\\n   268\u2192\\n   269\u2192project_tasks\\n   270\u2192  id                    UUID PK\\n   271\u2192  phase_id              UUID FK \u2192 project_phases.id (CASCADE)\\n   272\u2192  project_id            UUID FK \u2192 projects.id (CASCADE)\\n   273\u2192  user_id               UUID FK \u2192 users.id\\n   274\u2192  title                 str\\n   275\u2192  description           text | null\\n   276\u2192  acceptance_criteria   text | null\\n   277\u2192  order_index           int               \u2014 sort order within phase\\n   278\u2192  status                str               \u2014 \\\"todo\\\" | \\\"doing\\\" | \\\"in_review\\\" | \\\"done\\\" | \\\"failed\\\"\\n   279\u2192  branch_name           str | null\\n   280\u2192  pr_number             int | null\\n   281\u2192  issue_number          int | null\\n   282\u2192  claude_task_id        str | null\\n   283\u2192  error_message         text | null\\n   284\u2192  started_at            datetime(tz) | null\\n   285\u2192  completed_at          datetime(tz) | null\\n   286\u2192  created_at            datetime(tz)\\n   287\u2192  updated_at            datetime(tz)\\n   288\u2192```\\n   289\u2192\\n   290\u2192**ORM models** are in `agent/shared/shared/models/`. Each model file exports a single class.\\n   291\u2192\\n   292\u2192**Important**: Always use `mapped_column(DateTime(timezone=True))` for datetime fields. asyncpg rejects tz-aware datetimes against `TIMESTAMP WITHOUT TIME ZONE`.\\n   293\u2192\\n   294\u2192### Adding a New Table\\n   295\u2192\\n   296\u21921. Create model in `agent/shared/shared/models/new_thing.py`\\n   297\u21922. Import it in `agent/shared/shared/models/__init__.py`\\n   298\u21923. Create Alembic migration: `make shell` then `alembic revision --autogenerate -m \\\"add new_thing table\\\"`\\n   299\u21924. Apply: `make migrate`\\n   300\u2192\\n   301\u2192## Configuration (Settings)\\n   302\u2192\\n   303\u2192All config is in `agent/shared/shared/config.py` using pydantic-settings. Environment variables are loaded from `agent/.env`.\\n   304\u2192\\n   305\u2192Key settings:\\n   306\u2192- `database_url` \u2014 PostgreSQL async connection string\\n   307\u2192- `redis_url` \u2014 Redis connection\\n   308\u2192- `minio_endpoint`, `minio_access_key`, `minio_secret_key`, `minio_bucket`, `minio_public_url`\\n   309\u2192- `anthropic_api_key`, `openai_api_key`, `google_api_key` \u2014 LLM provider keys\\n   310\u2192- `default_model` \u2014 Primary chat model (default: `claude-sonnet-4-20250514`)\\n   311\u2192- `fallback_chain` \u2014 Comma-separated fallback models\\n   312\u2192- `module_services` \u2014 Dict mapping module name \u2192 internal HTTP URL\\n   313\u2192- `discord_token`, `telegram_token`, `slack_bot_token`, `slack_app_token`\\n   314\u2192\\n   315\u2192**Gotcha**: `list[str]` fields break with pydantic-settings v2 when env vars contain plain strings like `VAR=foo,bar`. Use `str` type and the `parse_list()` helper at point of use instead.\\n   316\u2192\\n   317\u2192## How to Implement a New Module\\n   318\u2192\\n   319\u2192Modules are independent FastAPI microservices. The orchestrator discovers them via `GET /manifest` and routes tool calls via `POST /execute`. Full guide: `agent/docs/ADDING_MODULES.md`.\\n   320\u2192\\n   321\u2192### File Structure\\n   322\u2192\\n   323\u2192```\\n   324\u2192agent/modules/my_module/\\n   325\u2192\u251c\u2500\u2500 __init__.py          # Empty\\n   326\u2192\u251c\u2500\u2500 Dockerfile\\n   327\u2192\u251c\u2500\u2500 requirements.txt\\n   328\u2192\u251c\u2500\u2500 main.py              # FastAPI app: /manifest, /execute, /health\\n   329\u2192\u251c\u2500\u2500 manifest.py          # ToolDefinition list\\n   330\u2192\u2514\u2500\u2500 tools.py             # Async tool method implementations\\n   331\u2192```\\n   332\u2192\\n   333\u2192### Step 1: Define the Manifest (`manifest.py`)\\n   334\u2192\\n   335\u2192```python\\n   336\u2192from shared.schemas.tools import ModuleManifest, ToolDefinition, ToolParameter\\n   337\u2192\\n   338\u2192MANIFEST = ModuleManifest(\\n   339\u2192    module_name=\\\"my_module\\\",\\n   340\u2192    description=\\\"What this module does.\\\",\\n   341\u2192    tools=[\\n   342\u2192        ToolDefinition(\\n   343\u2192            name=\\\"my_module.do_thing\\\",           # MUST be \\\"module_name.tool_name\\\"\\n   344\u2192            description=\\\"Clear description for the LLM to read.\\\",\\n   345\u2192            parameters=[\\n   346\u2192                ToolParameter(name=\\\"query\\\", type=\\\"string\\\", description=\\\"...\\\", required=True),\\n   347\u2192                ToolParameter(name=\\\"limit\\\", type=\\\"integer\\\", description=\\\"...\\\", required=False),\\n   348\u2192            ],\\n   349\u2192            required_permission=\\\"guest\\\",         # guest | user | admin | owner\\n   350\u2192        ),\\n   351\u2192    ],\\n   352\u2192)\\n   353\u2192```\\n   354\u2192\\n   355\u2192Parameter types: `string`, `integer`, `number`, `boolean`, `array`, `object`.\\n   356\u2192\\n   357\u2192### Step 2: Implement Tools (`tools.py`)\\n   358\u2192\\n   359\u2192```python\\n   360\u2192import structlog\\n   361\u2192\\n   362\u2192logger = structlog.get_logger()\\n   363\u2192\\n   364\u2192class MyModuleTools:\\n   365\u2192    def __init__(self):\\n   366\u2192        pass  # initialize clients, DB connections, etc.\\n   367\u2192\\n   368\u2192    async def do_thing(self, query: str, limit: int = 10) -> dict:\\n   369\u2192        \\\"\\\"\\\"Method name MUST match the part after the dot in tool name.\\\"\\\"\\\"\\n   370\u2192        return {\\\"results\\\": [...], \\\"count\\\": 5}\\n   371\u2192```\\n   372\u2192\\n   373\u2192- Methods must be `async`\\n   374\u2192- Method parameter names must match manifest parameter names\\n   375\u2192- Return any JSON-serializable value (dict, list, str, int, bool)\\n   376\u2192- Raise exceptions on failure \u2014 main.py catches them\\n   377\u2192- Accept `user_id: str | None = None` if you need user context (injected by orchestrator)\\n   378\u2192\\n   379\u2192### Step 3: Create the FastAPI App (`main.py`)\\n   380\u2192\\n   381\u2192```python\\n   382\u2192from fastapi import FastAPI\\n   383\u2192from modules.my_module.manifest import MANIFEST\\n   384\u2192from modules.my_module.tools import MyModuleTools\\n   385\u2192from shared.schemas.tools import ModuleManifest, ToolCall, ToolResult\\n   386\u2192from shared.schemas.common import HealthResponse\\n   387\u2192\\n   388\u2192app = FastAPI(title=\\\"My Module\\\")\\n   389\u2192tools: MyModuleTools | None = None\\n   390\u2192\\n   391\u2192@app.on_event(\\\"startup\\\")\\n   392\u2192async def startup():\\n   393\u2192    global tools\\n   394\u2192    tools = MyModuleTools()\\n   395\u2192\\n   396\u2192@app.get(\\\"/manifest\\\", response_model=ModuleManifest)\\n   397\u2192async def manifest():\\n   398\u2192    return MANIFEST\\n   399\u2192\\n   400\u2192@app.post(\\\"/execute\\\", response_model=ToolResult)\\n   401\u2192async def execute(call: ToolCall):\\n   402\u2192    if tools is None:\\n   403\u2192        return ToolResult(tool_name=call.tool_name, success=False, error=\\\"Module not ready\\\")\\n   404\u2192    try:\\n   405\u2192        tool_name = call.tool_name.split(\\\".\\\")[-1]\\n   406\u2192        args = dict(call.arguments)\\n   407\u2192        if call.user_id:\\n   408\u2192            args[\\\"user_id\\\"] = call.user_id\\n   409\u2192        if tool_name == \\\"do_thing\\\":\\n   410\u2192            result = await tools.do_thing(**args)\\n   411\u2192        else:\\n   412\u2192            return ToolResult(tool_name=call.tool_name, success=False, error=f\\\"Unknown tool: {call.tool_name}\\\")\\n   413\u2192        return ToolResult(tool_name=call.tool_name, success=True, result=result)\\n   414\u2192    except Exception as e:\\n   415\u2192        return ToolResult(tool_name=call.tool_name, success=False, error=str(e))\\n   416\u2192\\n   417\u2192@app.get(\\\"/health\\\", response_model=HealthResponse)\\n   418\u2192async def health():\\n   419\u2192    return HealthResponse(status=\\\"ok\\\")\\n   420\u2192```\\n   421\u2192\\n   422\u2192### Step 4: Dockerfile\\n   423\u2192\\n   424\u2192```dockerfile\\n   425\u2192FROM python:3.12-slim\\n   426\u2192WORKDIR /app\\n   427\u2192COPY shared/ /shared/\\n   428\u2192RUN pip install --no-cache-dir /shared/\\n   429\u2192COPY modules/my_module/requirements.txt .\\n   430\u2192RUN pip install --no-cache-dir -r requirements.txt\\n   431\u2192COPY modules/ /app/modules/\\n   432\u2192ENV PYTHONPATH=\\\"/app:/shared\\\"\\n   433\u2192EXPOSE 8000\\n   434\u2192CMD [\\\"uvicorn\\\", \\\"modules.my_module.main:app\\\", \\\"--host\\\", \\\"0.0.0.0\\\", \\\"--port\\\", \\\"8000\\\"]\\n   435\u2192```\\n   436\u2192\\n   437\u2192### Step 5: requirements.txt\\n   438\u2192\\n   439\u2192```\\n   440\u2192fastapi>=0.109\\n   441\u2192uvicorn[standard]>=0.27\\n   442\u2192structlog>=24.1\\n   443\u2192pydantic>=2.5\\n   444\u2192pydantic-settings>=2.1\\n   445\u2192# Add sqlalchemy>=2.0, asyncpg>=0.29 if using DB\\n   446\u2192# Add minio>=7.2 if using file storage\\n   447\u2192```\\n   448\u2192\\n   449\u2192### Step 6: Register the Module\\n   450\u2192\\n   451\u2192**a) `agent/shared/shared/config.py`** \u2014 Add to `module_services` dict:\\n   452\u2192```python\\n   453\u2192\\\"my_module\\\": \\\"http://my-module:8000\\\",\\n   454\u2192```\\n   455\u2192\\n   456\u2192**b) `agent/docker-compose.yml`** \u2014 Add service block:\\n   457\u2192```yaml\\n   458\u2192  my-module:\\n   459\u2192    build:\\n   460\u2192      context: .\\n   461\u2192      dockerfile: modules/my_module/Dockerfile\\n   462\u2192    env_file: .env\\n   463\u2192    depends_on:\\n   464\u2192      - core\\n   465\u2192    networks:\\n   466\u2192      - agent-net\\n   467\u2192    restart: unless-stopped\\n   468\u2192```\\n   469\u2192\\n   470\u2192Add `postgres` / `minio` to `depends_on` if your module accesses them directly.\\n   471\u2192\\n   472\u2192**Note**: Docker service name uses hyphens (`my-module`), Python module name uses underscores (`my_module`). The hostname on the Docker network is the service name.\\n   473\u2192\\n   474\u2192### Step 7: Build and Start\\n   475\u2192\\n   476\u2192```bash\\n   477\u2192make build-module M=my-module\\n   478\u2192make up\\n   479\u2192make refresh-tools  # tell core to re-discover manifests\\n   480\u2192```\\n   481\u2192\\n   482\u2192## Shared Package Usage\\n   483\u2192\\n   484\u2192All services install `agent/shared/` as a Python package. Import from `shared.*`:\\n   485\u2192\\n   486\u2192```python\\n   487\u2192from shared.config import get_settings, parse_list\\n   488\u2192from shared.database import get_session_factory\\n   489\u2192from shared.models.user import User\\n   490\u2192from shared.models.file import FileRecord\\n   491\u2192from shared.schemas.tools import ToolCall, ToolResult, ModuleManifest\\n   492\u2192from shared.schemas.messages import IncomingMessage, AgentResponse\\n   493\u2192```\\n   494\u2192\\n   495\u2192### Database Access\\n   496\u2192\\n   497\u2192```python\\n   498\u2192from shared.database import get_session_factory\\n   499\u2192from sqlalchemy import select\\n   500\u2192\\n   501\u2192session_factory = get_session_factory()\\n   502\u2192\\n   503\u2192async def my_function():\\n   504\u2192    async with session_factory() as session:\\n   505\u2192        result = await session.execute(select(User).where(User.id == some_id))\\n   506\u2192        user = result.scalar_one_or_none()\\n   507\u2192```\\n   508\u2192\\n   509\u2192### MinIO Access\\n   510\u2192\\n   511\u2192```python\\n   512\u2192from minio import Minio\\n   513\u2192from shared.config import get_settings\\n   514\u2192\\n   515\u2192settings = get_settings()\\n   516\u2192minio_client = Minio(\\n   517\u2192    settings.minio_endpoint,\\n   518\u2192    access_key=settings.minio_access_key,\\n   519\u2192    secret_key=settings.minio_secret_key,\\n   520\u2192    secure=False,\\n   521\u2192)\\n   522\u2192```\\n   523\u2192\\n   524\u2192### Embeddings (via Core API)\\n   525\u2192\\n   526\u2192```python\\n   527\u2192import httpx\\n   528\u2192from shared.config import get_settings\\n   529\u2192\\n   530\u2192settings = get_settings()\\n   531\u2192\\n   532\u2192async def get_embedding(text: str) -> list[float] | None:\\n   533\u2192    async with httpx.AsyncClient(timeout=15.0) as client:\\n   534\u2192        resp = await client.post(f\\\"{settings.orchestrator_url}/embed\\\", json={\\\"text\\\": text})\\n   535\u2192        if resp.status_code == 200:\\n   536\u2192            return resp.json().get(\\\"embedding\\\")\\n   537\u2192    return None\\n   538\u2192```\\n   539\u2192\\n   540\u2192## Core Orchestrator Internals\\n   541\u2192\\n   542\u2192### Agent Loop (`agent/core/orchestrator/agent_loop.py`)\\n   543\u2192\\n   544\u2192The main reasoning cycle:\\n   545\u2192\\n   546\u21921. **Resolve user** \u2014 maps `(platform, platform_user_id)` \u2192 `User` record (auto-creates guests)\\n   547\u21922. **Check budget** \u2014 verify monthly token allowance\\n   548\u21923. **Resolve persona** \u2014 server-specific \u2192 platform-specific \u2192 default\\n   549\u21924. **Resolve conversation** \u2014 find active conversation in channel/thread or create new one\\n   550\u21925. **Filter tools** \u2014 by user `permission_level` and persona's `allowed_modules`\\n   551\u21926. **Register attachments** \u2014 create `FileRecord` entries, enrich user message with file context\\n   552\u21927. **Build context** \u2014 system prompt + semantic memories (pgvector) + conversation summary + recent messages\\n   553\u21928. **Loop** (up to `max_agent_iterations`, default 10):\\n   554\u2192   - Call LLM with context + tools\\n   555\u2192   - If stop_reason is `tool_use`: execute tools, append results to context, continue\\n   556\u2192   - Otherwise: break with final text content\\n   557\u21929. **Return** `AgentResponse(content, files)`\\n   558\u2192\\n   559\u2192### LLM Router (`agent/core/llm_router/router.py`)\\n   560\u2192\\n   561\u2192- Routes to Anthropic (Claude), OpenAI (GPT-4o), or Google (Gemini) based on model name\\n   562\u2192- Fallback chain: tries next provider if primary fails\\n   563\u2192- Providers only registered if their API key is set\\n   564\u2192- Each provider normalizes to a common `LLMResponse` format\\n   565\u2192\\n   566\u2192### Tool Registry (`agent/core/orchestrator/tool_registry.py`)\\n   567\u2192\\n   568\u2192- On startup, fetches `GET /manifest` from each module in `module_services`\\n   569\u2192- Caches manifests in Redis (1-hour TTL)\\n   570\u2192- Filters tools by user permission level before sending to LLM\\n   571\u2192- Routes `POST /execute` to the correct module by splitting tool name on first `.`\\n   572\u2192\\n   573\u2192## Communication Layer (Bots)\\n   574\u2192\\n   575\u2192Each bot follows the same pattern:\\n   576\u2192\\n   577\u21921. Receive platform event (message, mention, etc.)\\n   578\u21922. Normalize to `IncomingMessage` (with attachments uploaded to MinIO)\\n   579\u21923. POST to core `/message`\\n   580\u21924. Format `AgentResponse` for the platform\\n   581\u21925. Send reply (with file attachments downloaded from MinIO for inline display)\\n   582\u2192\\n   583\u2192Key files:\\n   584\u2192- `agent/comms/discord_bot/bot.py` \u2014 Discord.py client\\n   585\u2192- `agent/comms/telegram_bot/bot.py` \u2014 python-telegram-bot\\n   586\u2192- `agent/comms/slack_bot/bot.py` \u2014 slack-bolt\\n   587\u2192\\n   588\u2192Shared file upload utility: `agent/shared/shared/file_utils.py` \u2014 `upload_attachment()` uploads raw bytes to MinIO and returns metadata dict (no DB writes \u2014 core creates FileRecords after user resolution).\\n   589\u2192\\n   590\u2192## Makefile Commands\\n   591\u2192\\n   592\u2192```bash\\n   593\u2192make setup              # First-time: build, migrate, create bucket + default persona, start all\\n   594\u2192make up                 # Start all services\\n   595\u2192make down               # Stop all services\\n   596\u2192make build              # Rebuild all images\\n   597\u2192make build-core         # Rebuild core image\\n   598\u2192make build-module M=x   # Rebuild specific module\\n   599\u2192make restart-core       # Rebuild + restart core\\n   600\u2192make restart-module M=x # Rebuild + restart a module\\n   601\u2192make restart-bots       # Restart all bots\\n   602\u2192make logs               # Tail all logs\\n   603\u2192make logs-core          # Tail core logs\\n   604\u2192make logs-module M=x    # Tail module logs\\n   605\u2192make logs-bots          # Tail bot logs\\n   606\u2192make create-owner DISCORD_ID=123  # Create owner user\\n   607\u2192make list-users         # List users\\n   608\u2192make list-modules       # Show module health\\n   609\u2192make refresh-tools      # Re-discover module manifests\\n   610\u2192make shell              # Bash into core container\\n   611\u2192make psql               # PostgreSQL shell\\n   612\u2192make redis-cli          # Redis CLI\\n   613\u2192make migrate            # Run Alembic migrations\\n   614\u2192```\\n   615\u2192\\n   616\u2192## Permission Levels\\n   617\u2192\\n   618\u2192From lowest to highest: `guest` \u2192 `user` \u2192 `admin` \u2192 `owner`\\n   619\u2192\\n   620\u2192- Each tool declares `required_permission` in its manifest\\n   621\u2192- The orchestrator filters tools so users only see what they're allowed to use\\n   622\u2192- Guests are auto-created on first message with a limited token budget\\n   623\u2192- Budget is `null` (unlimited) for admin/owner\\n   624\u2192\\n   625\u2192## Known Gotchas\\n   626\u2192\\n   627\u2192### pydantic-settings v2\\n   628\u2192`list[str]` fields fail with plain env vars like `VAR=foo,bar` \u2014 pydantic-settings attempts JSON parse in `decode_complex_value` BEFORE field validators run. **Fix**: use `str` type and `parse_list()` at point of use.\\n   629\u2192\\n   630\u2192### asyncpg + DateTime\\n   631\u2192`Mapped[datetime]` maps to `TIMESTAMP WITHOUT TIME ZONE`. asyncpg rejects tz-aware datetimes for it. **Fix**: always use `mapped_column(DateTime(timezone=True), ...)` in models.\\n   632\u2192\\n   633\u2192### Google GenAI SDK\\n   634\u2192- Use `contents=` (plural), not `content=` for `embed_content`\\n   635\u2192- `gemini-embedding-001` outputs 3072 dims by default; use `EmbedContentConfig(output_dimensionality=1536)` to match `Vector(1536)` in DB\\n   636\u2192- Function names must be alphanumeric + underscore (no dots). The Google provider sanitizes with `__` and maintains a reverse `name_map`\\n   637\u2192- `MALFORMED_FUNCTION_CALL` is a known transient Gemini issue \u2014 the provider retries automatically\\n   638\u2192\\n   639\u2192### Docker\\n   640\u2192- Bots with `restart: unless-stopped` + `sys.exit(1)` on missing tokens = crash-loop log spam. Use `time.sleep(86400)` to idle instead\\n   641\u2192- Module DNS may not resolve when core starts \u2014 core has delayed background retry for manifest discovery\\n   642\u2192- Never create `alembic/__init__.py` in the migrations dir \u2014 it shadows the `alembic` library\\n   643\u2192\\n   644\u2192### Dependencies\\n   645\u2192- DuckDuckGo search library is `ddgs` (renamed from `duckduckgo-search`), same API: `from ddgs import DDGS`\\n   646\u2192- `slack-bolt` async mode needs `aiohttp` but doesn't declare it as a hard dependency\\n   647\u2192\\n   648\u2192### Cross-Container DB Visibility\\n   649\u2192Use `session.commit()` (not `session.flush()`) when another container needs to see the data. `flush()` writes within the local transaction only.\\n   650\u2192\\n   651\u2192## File Pipeline\\n   652\u2192\\n   653\u2192### User uploads a file (Discord/Telegram/Slack)\\n   654\u21921. Bot downloads the file from platform CDN\\n   655\u21922. Bot uploads to MinIO via `upload_attachment()` from `shared/file_utils.py`\\n   656\u21923. Bot sends `IncomingMessage` with `attachments: [{filename, url, minio_key, mime_type, size_bytes}]`\\n   657\u21924. Core creates `FileRecord` in DB with the real `user_id` (bots don't know internal user IDs)\\n   658\u21925. Core enriches the user message with file context (file_id, usage hints)\\n   659\u21926. LLM can use `file_manager.read_document(file_id)` or `code_executor.load_file(file_id)` to access the file\\n   660\u2192\\n   661\u2192### Agent generates a file (e.g., code_executor creates a plot)\\n   662\u21921. Code executor saves to `/tmp/`, detects new files, uploads to MinIO\\n   663\u21922. Code executor creates `FileRecord` in DB\\n   664\u21923. Tool result includes `files: [{filename, url, minio_key}]`\\n   665\u21924. Orchestrator extracts file URLs from tool results (both top-level `url` and nested `files[]`)\\n   666\u21925. Bot downloads files from MinIO (internal network) and attaches as native platform files\\n   667\u2192\\n   668\u2192## Existing Module Reference\\n   669\u2192\\n   670\u2192| Module | Tools | Infrastructure | Permission |\\n   671\u2192|---|---|---|---|\\n   672\u2192| `research` | `web_search`, `news_search`, `fetch_webpage`, `summarize_text` | None | guest |\\n   673\u2192| `file_manager` | `create_document`, `upload_file`, `read_document`, `list_files`, `get_file_link`, `delete_file` | PostgreSQL, MinIO | guest |\\n   674\u2192| `code_executor` | `run_python`, `run_shell`, `load_file` | PostgreSQL, MinIO | guest/user |\\n   675\u2192| `knowledge` | `remember`, `recall`, `list_memories`, `forget` | PostgreSQL (pgvector) | guest |\\n   676\u2192| `atlassian` | `jira_search`, `jira_get_issue`, `jira_create_issue`, `jira_update_issue`, `confluence_search`, `confluence_get_page`, `confluence_create_page`, `confluence_update_page`, `create_meeting_notes`, `create_feature_doc` | None (external API) | user |\\n   677\u2192| `claude_code` | `run_task`, `continue_task`, `task_status`, `task_logs`, `cancel_task`, `list_tasks` | Docker socket | admin |\\n   678\u2192| `deployer` | `deploy`, `list_deployments`, `teardown`, `teardown_all`, `get_logs` | Docker socket | user/admin |\\n   679\u2192| `scheduler` | `add_job`, `list_jobs`, `cancel_job` | PostgreSQL, Redis | admin |\\n   680\u2192| `garmin` | `get_daily_summary`, `get_heart_rate`, `get_sleep`, `get_body_composition`, `get_activities`, `get_stress`, `get_steps` | None (external API) | user |\\n   681\u2192| `renpho_biometrics` | `get_measurements`, `get_latest`, `get_trend` | None (external API) | user |\\n   682\u2192| `location` | `create_reminder`, `list_reminders`, `cancel_reminder`, `get_location`, `set_named_place`, `generate_pairing_credentials` | PostgreSQL, Redis | user |\\n   683\u2192| `project_planner` | `create_project`, `update_project`, `get_project`, `list_projects`, `delete_project`, `add_phase`, `update_phase`, `add_task`, `bulk_add_tasks`, `update_task`, `get_task`, `get_phase_tasks`, `get_next_task`, `get_project_status` | PostgreSQL | user/admin |\\n   684\u2192| `injective` | `get_portfolio`, `get_market_price`, `place_order`, `cancel_order`, `get_positions` | None (scaffold) | owner |\\n   685\u2192\\n\\n<system-reminder>\\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\\n</system-reminder>\\n\"}]},\"parent_tool_use_id\":null,\"session_id\":\"35c5c018-5c2e-45db-b550-126fc370d3fa\",\"uuid\":\"4904031a-0a31-417b-ab6c-ef69d5d3eb7d\",\"tool_use_result\":{\"type\":\"text\",\"file\":{\"filePath\":\"/tmp/claude_tasks/670be485f9a4/CLAUDE.md\",\"content\":\"# AI Agent System \u2014 Developer Guide\\n\\n## Quick Reference\\n\\n```\\nProject root:   /home/user/my_agent\\nApp code:       /home/user/my_agent/agent/\\nCompose file:   agent/docker-compose.yml\\nShared package: agent/shared/shared/\\nModels:         agent/shared/shared/models/\\nSchemas:        agent/shared/shared/schemas/\\nCore service:   agent/core/\\nModules:        agent/modules/<name>/\\nBots:           agent/comms/<platform>_bot/\\nMigrations:     agent/alembic/versions/\\nMakefile:       Makefile (top-level, wraps docker compose)\\n```\\n\\n## Architecture Overview\\n\\n```\\n Discord / Telegram / Slack\\n         \u2502\\n    Communication Layer (bots)\\n         \u2502  POST /message (IncomingMessage \u2192 AgentResponse)\\n         \u25bc\\n    Core Orchestrator (FastAPI :8000)\\n    \u251c\u2500\u2500 Agent Loop (reason/act/observe cycle, up to 10 iterations)\\n    \u251c\u2500\u2500 LLM Router (Anthropic, OpenAI, Google \u2014 with fallback chain)\\n    \u251c\u2500\u2500 Context Builder (system prompt + memories + history)\\n    \u2514\u2500\u2500 Tool Registry (discovers modules via GET /manifest)\\n         \u2502  POST /execute (ToolCall \u2192 ToolResult)\\n         \u25bc\\n    Module Layer (independent FastAPI microservices)\\n    \u251c\u2500\u2500 research          \u2014 web search, scraping, news\\n    \u251c\u2500\u2500 file_manager      \u2014 file CRUD on MinIO + DB records\\n    \u251c\u2500\u2500 code_executor     \u2014 sandboxed Python/shell execution\\n    \u251c\u2500\u2500 knowledge         \u2014 persistent per-user memory with embeddings\\n    \u251c\u2500\u2500 atlassian         \u2014 Jira + Confluence integration\\n    \u251c\u2500\u2500 claude_code       \u2014 coding tasks via Claude Code CLI in Docker\\n    \u251c\u2500\u2500 deployer          \u2014 deploy projects to live URLs\\n    \u251c\u2500\u2500 scheduler         \u2014 background job monitoring + notifications\\n    \u251c\u2500\u2500 garmin            \u2014 Garmin Connect health/fitness data\\n    \u251c\u2500\u2500 renpho_biometrics \u2014 Renpho smart scale body composition\\n    \u251c\u2500\u2500 location          \u2014 OwnTracks geofence reminders + tracking\\n    \u251c\u2500\u2500 project_planner   \u2014 project planning, tracking + autonomous execution\\n    \u2514\u2500\u2500 injective         \u2014 blockchain trading (scaffold)\\n\\n Infrastructure: PostgreSQL+pgvector \u2502 Redis \u2502 MinIO (S3)\\n```\\n\\nAll services communicate over the `agent-net` Docker bridge network. Services are containerized with Python 3.12-slim base images.\\n\\n## Module Documentation\\n\\nDetailed per-module docs live in `agent/docs/modules/`:\\n\\n- [Module System Overview](agent/docs/modules/overview.md) \u2014 discovery, routing, permissions, workflow chaining\\n- [research](agent/docs/modules/research.md) \u2014 web search, news, scraping, summarization\\n- [file_manager](agent/docs/modules/file_manager.md) \u2014 file CRUD on MinIO + DB records\\n- [code_executor](agent/docs/modules/code_executor.md) \u2014 sandboxed Python/shell execution\\n- [knowledge](agent/docs/modules/knowledge.md) \u2014 semantic memory with pgvector embeddings\\n- [atlassian](agent/docs/modules/atlassian.md) \u2014 Jira + Confluence integration\\n- [claude_code](agent/docs/modules/claude_code.md) \u2014 coding tasks via Claude Code CLI in Docker\\n- [deployer](agent/docs/modules/deployer.md) \u2014 deploy projects to live URLs\\n- [scheduler](agent/docs/modules/scheduler.md) \u2014 background jobs + workflow chaining\\n- [garmin](agent/docs/modules/garmin.md) \u2014 Garmin Connect health/fitness data\\n- [renpho_biometrics](agent/docs/modules/renpho_biometrics.md) \u2014 Renpho smart scale body composition\\n- [location](agent/docs/modules/location.md) \u2014 OwnTracks geofence reminders + tracking\\n- [git_platform](agent/docs/modules/git_platform.md) \u2014 GitHub/Bitbucket repos, issues, PRs, CI\\n- [myfitnesspal](agent/docs/modules/myfitnesspal.md) \u2014 nutrition and meal tracking\\n- [project_planner](agent/docs/modules/project_planner.md) \u2014 project planning, tracking + autonomous execution\\n- [injective](agent/docs/modules/injective.md) \u2014 blockchain spot and perpetual trading\\n\\n## Tech Stack\\n\\n| Layer | Technology |\\n|---|---|\\n| Language | Python 3.12 |\\n| Web framework | FastAPI + uvicorn |\\n| Database | PostgreSQL 16 with pgvector extension |\\n| ORM | SQLAlchemy 2.0 (async, via asyncpg) |\\n| Migrations | Alembic |\\n| Cache | Redis 7 |\\n| File storage | MinIO (S3-compatible) |\\n| LLM SDKs | `anthropic`, `openai`, `google-genai` |\\n| Logging | structlog (JSON output) |\\n| Config | pydantic-settings v2 |\\n| Container orchestration | Docker Compose |\\n| Admin dashboard | Streamlit |\\n\\n## Database Schema\\n\\nAll tables use UUID primary keys and `DateTime(timezone=True)` for timestamps.\\n\\n```\\nusers\\n  id                    UUID PK\\n  permission_level      str        \u2014 \\\"guest\\\" | \\\"user\\\" | \\\"admin\\\" | \\\"owner\\\"\\n  token_budget_monthly  int | null \u2014 null = unlimited\\n  tokens_used_this_month int\\n  budget_reset_at       datetime(tz)\\n  created_at            datetime(tz)\\n\\nuser_platform_links\\n  id                    UUID PK\\n  user_id               UUID FK \u2192 users.id\\n  platform              str        \u2014 \\\"discord\\\" | \\\"telegram\\\" | \\\"slack\\\"\\n  platform_user_id      str\\n  platform_username     str | null\\n  UNIQUE(platform, platform_user_id)\\n\\npersonas\\n  id                    UUID PK\\n  name                  str\\n  system_prompt         text\\n  platform              str | null   \u2014 scope to a platform\\n  platform_server_id    str | null   \u2014 scope to a server/guild\\n  allowed_modules       str (JSON)   \u2014 e.g. '[\\\"research\\\",\\\"file_manager\\\"]'\\n  default_model         str | null\\n  max_tokens_per_request int         \u2014 default 4000\\n  is_default            bool\\n  created_at            datetime(tz)\\n\\nconversations\\n  id                    UUID PK\\n  user_id               UUID FK \u2192 users.id\\n  persona_id            UUID FK \u2192 personas.id (nullable)\\n  platform              str\\n  platform_channel_id   str\\n  platform_thread_id    str | null\\n  started_at            datetime(tz)\\n  last_active_at        datetime(tz)\\n  is_summarized         bool\\n\\nmessages\\n  id                    UUID PK\\n  conversation_id       UUID FK \u2192 conversations.id\\n  role                  str        \u2014 \\\"user\\\" | \\\"assistant\\\" | \\\"system\\\" | \\\"tool_call\\\" | \\\"tool_result\\\"\\n  content               text\\n  token_count           int | null\\n  model_used            str | null\\n  created_at            datetime(tz)\\n\\nmemory_summaries\\n  id                    UUID PK\\n  user_id               UUID FK \u2192 users.id\\n  conversation_id       UUID FK \u2192 conversations.id (nullable)\\n  summary               text\\n  embedding             Vector(1536)\\n  created_at            datetime(tz)\\n\\ntoken_logs\\n  id                    UUID PK\\n  user_id               UUID FK \u2192 users.id\\n  conversation_id       UUID FK \u2192 conversations.id\\n  model                 str\\n  input_tokens          int\\n  output_toke",
    "token_summary": {
      "total_input_tokens": 30,
      "total_output_tokens": 14,
      "total_cache_read_tokens": 82104,
      "total_cache_creation_tokens": 79658,
      "latest_context_tokens": 6,
      "num_turns": 6,
      "model": "claude-sonnet-4-5-20250929"
    },
    "plan_content": "# Documentation Improvement Plan\n\n## Project Goal\n\nImprove the agent system documentation to make development easier for both human and AI developers. Focus on creating comprehensive feature documentation that provides quick, contextual access to relevant information when working on specific features or components.\n\n## Current State Analysis\n\n### Existing Documentation\n\n**Strong points:**\n- Comprehensive CLAUDE.md with architecture overview, quick reference, and detailed module creation guide\n- Individual module documentation in `agent/docs/modules/` (17+ modules documented)\n- ADDING_MODULES.md provides step-by-step guide for creating new modules\n- portal.md documents the web portal architecture\n- README.md provides good quick start guide\n\n**Weaknesses identified:**\n1. **No core service documentation** - Agent loop, tool registry, LLM router are only briefly mentioned in CLAUDE.md\n2. **No communication layer docs** - Discord/Telegram/Slack bot implementations undocumented\n3. **Inconsistent module docs** - Some modules (project_planner, claude_code) have detailed workflow docs, others (research, file_manager) are minimal\n4. **No feature-specific guides** - No docs on implementing cross-cutting features like adding new LLM providers, adding new platforms, implementing new DB tables\n5. **No troubleshooting guide** - \"Known Gotchas\" section exists but scattered throughout CLAUDE.md\n6. **No API reference** - No centralized docs for shared schemas, database models, or internal APIs\n7. **Missing diagrams** - Only ASCII art architecture diagrams\n8. **No testing documentation** - No guidance on testing modules or core services\n9. **No deployment documentation** - Production deployment scenarios not covered\n10. **Context access difficulty** - When working on a feature, agents need to read multiple files to gather context\n\n## Design Principles\n\n### Documentation Structure Philosophy\n\n1. **Hierarchical organization**: Top-level overview \u2192 component-specific \u2192 feature-specific\n2. **Progressive disclosure**: Quick reference at top, details below\n3. **Agent-friendly formatting**: Clear section headers, tables, code examples with context\n4. **Cross-referencing**: Link related docs explicitly\n5. **Location awareness**: Each doc states its scope and related files\n6. **Searchability**: Consistent naming conventions, keywords in headers\n\n### Target Audiences\n\n1. **AI agents** (primary): Working on specific features, need fast context access\n2. **Human developers** (secondary): Understanding system architecture, adding features\n3. **New contributors**: Getting started, understanding conventions\n\n## Proposed Documentation Structure\n\n```\nagent/\n\u251c\u2500\u2500 CLAUDE.md                          # [ENHANCED] Main entry point + quick reference\n\u251c\u2500\u2500 README.md                          # [KEEP] User-facing quick start\n\u251c\u2500\u2500 docs/\n\u2502   \u251c\u2500\u2500 INDEX.md                       # [NEW] Complete documentation index with descriptions\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 architecture/                  # [NEW] System architecture deep dives\n\u2502   \u2502   \u251c\u2500\u2500 overview.md               # High-level system design\n\u2502   \u2502   \u251c\u2500\u2500 data-flow.md              # Request/response lifecycle diagrams\n\u2502   \u2502   \u251c\u2500\u2500 database-schema.md        # Complete schema with relationships\n\u2502   \u2502   \u251c\u2500\u2500 module-system.md          # Module discovery, routing, execution\n\u2502   \u2502   \u2514\u2500\u2500 deployment.md             # Docker compose, networking, volumes\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 core/                          # [NEW] Core service documentation\n\u2502   \u2502   \u251c\u2500\u2500 overview.md               # Core service architecture\n\u2502   \u2502   \u251c\u2500\u2500 agent-loop.md             # Agent loop internals, iteration cycle\n\u2502   \u2502   \u251c\u2500\u2500 tool-registry.md          # Discovery, caching, execution routing\n\u2502   \u2502   \u251c\u2500\u2500 llm-router.md             # Provider abstraction, fallback chain\n\u2502   \u2502   \u251c\u2500\u2500 context-builder.md        # Memory retrieval, summarization, prompt building\n\u2502   \u2502   \u2514\u2500\u2500 memory-system.md          # Summarization, semantic recall, embeddings\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 comms/                         # [NEW] Communication layer docs\n\u2502   \u2502   \u251c\u2500\u2500 overview.md               # Bot architecture, common patterns\n\u2502   \u2502   \u251c\u2500\u2500 discord-bot.md            # Discord.py implementation details\n\u2502   \u2502   \u251c\u2500\u2500 telegram-bot.md           # python-telegram-bot implementation\n\u2502   \u2502   \u251c\u2500\u2500 slack-bot.md              # slack-bolt implementation\n\u2502   \u2502   \u2514\u2500\u2500 file-pipeline.md          # Attachment handling across platforms\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 modules/                       # [ENHANCED] Module documentation\n\u2502   \u2502   \u251c\u2500\u2500 overview.md               # [ENHANCED] Add discovery flow diagrams\n\u2502   \u2502   \u251c\u2500\u2500 ADDING_MODULES.md         # [MOVED] Move from parent dir\n\u2502   \u2502   \u251c\u2500\u2500 research.md               # [ENHANCED] Add implementation details\n\u2502   \u2502   \u251c\u2500\u2500 file_manager.md           # [ENHANCED] Add MinIO setup, error handling\n\u2502   \u2502   \u251c\u2500\u2500 code_executor.md          # [ENHANCED] Add security model, sandboxing\n\u2502   \u2502   \u251c\u2500\u2500 knowledge.md              # [ENHANCED] Add embedding flow, vector search\n\u2502   \u2502   \u251c\u2500\u2500 atlassian.md              # [KEEP] Already detailed\n\u2502   \u2502   \u251c\u2500\u2500 claude_code.md            # [ENHANCED] Add Docker-in-Docker details\n\u2502   \u2502   \u251c\u2500\u2500 deployer.md               # [ENHANCED] Add project type detection\n\u2502   \u2502   \u251c\u2500\u2500 scheduler.md              # [ENHANCED] Add workflow chaining examples\n\u2502   \u2502   \u251c\u2500\u2500 garmin.md                 # [ENHANCED] Add OAuth flow\n\u2502   \u2502   \u251c\u2500\u2500 renpho_biometrics.md      # [ENHANCED] Add API integration details\n\u2502   \u2502   \u251c\u2500\u2500 location.md               # [ENHANCED] Add OwnTracks protocol\n\u2502   \u2502   \u251c\u2500\u2500 git_platform.md           # [KEEP] Already detailed\n\u2502   \u2502   \u251c\u2500\u2500 myfitnesspal.md           # [ENHANCED] Add authentication\n\u2502   \u2502   \u251c\u2500\u2500 project_planner.md        # [KEEP] Already excellent\n\u2502   \u2502   \u2514\u2500\u2500 injective.md              # [ENHANCE] When implemented\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 features/                      # [NEW] Feature implementation guides\n\u2502   \u2502   \u251c\u2500\u2500 adding-llm-provider.md    # Step-by-step guide with code examples\n\u2502   \u2502   \u251c\u2500\u2500 adding-platform-bot.md    # New platform integration guide\n\u2502   \u2502   \u251c\u2500\u2500 adding-database-table.md  # Model creation, migration, relationships\n\u2502   \u2502   \u251c\u2500\u2500 adding-persona-features.md # Extending persona system\n\u2502   \u2502   \u251c\u2500\u2500 implementing-workflows.md # Multi-module workflow patterns\n\u2502   \u2502   \u251c\u2500\u2500 file-generation.md        # Creating and returning files from tools\n\u2502   \u2502   \u251c\u2500\u2500 background-jobs.md        # Scheduler integration patterns\n\u2502   \u2502   \u251c\u2500\u2500 authentication.md         # External API auth patterns\n\u2502   \u2502   \u2514\u2500\u2500 testing-modules.md        # Module testing strategies\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 api-reference/                 # [NEW] API and schema reference\n\u2502   \u2502   \u251c\u2500\u2500 shared-schemas.md         # ToolCall, ToolResult, IncomingMessage, etc.\n\u2502   \u2502   \u251c\u2500\u2500 database-models.md        # All ORM models with relationships\n\u2502   \u2502   \u251c\u2500\u2500 core-endpoints.md         # Core service HTTP/WS endpoints\n\u2502   \u2502   \u251c\u2500\u2500 module-contract.md        # /manifest, /execute, /health specs\n\u2502   \u2502   \u2514\u2500\u2500 shared-utilities.md       # Config helpers, database utilities\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 development/                   # [NEW] Development workflows\n\u2502   \u2502   \u251c\u2500\u2500 getting-started.md        # Local setup, first module\n\u2502   \u2502   \u251c\u2500\u2500 testing.md                # Testing strategies, fixtures\n\u2502   \u2502   \u251c\u2500\u2500 debugging.md              # Log analysis, common issues\n\u2502   \u2502   \u251c\u2500\u2500 makefile-reference.md     # All make targets explained\n\u2502   \u2502   \u2514\u2500\u2500 code-standards.md         # Python conventions, structlog usage\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 deployment/                    # [NEW] Production deployment\n\u2502   \u2502   \u251c\u2500\u2500 production-setup.md       # Production docker-compose, env vars\n\u2502   \u2502   \u251c\u2500\u2500 secrets-management.md     # API keys, credentials\n\u2502   \u2502   \u251c\u2500\u2500 monitoring.md             # Logging, metrics, alerting\n\u2502   \u2502   \u251c\u2500\u2500 backup-restore.md         # Database and file backups\n\u2502   \u2502   \u2514\u2500\u2500 scaling.md                # Horizontal scaling considerations\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 troubleshooting/               # [NEW] Problem diagnosis\n\u2502   \u2502   \u251c\u2500\u2500 common-issues.md          # FAQ and solutions\n\u2502   \u2502   \u251c\u2500\u2500 module-issues.md          # Module-specific troubleshooting\n\u2502   \u2502   \u251c\u2500\u2500 platform-issues.md        # Bot connection problems\n\u2502   \u2502   \u251c\u2500\u2500 database-issues.md        # Migration, query problems\n\u2502   \u2502   \u2514\u2500\u2500 performance.md            # Performance debugging\n\u2502   \u2502\n\u2502   \u2514\u2500\u2500 portal.md                      # [MOVED] Move to docs/ for consistency\n```\n\n## Implementation Phases\n\n### Phase 1: Documentation Infrastructure & Index (Foundation)\n\n**Goal:** Create the documentation structure and navigation system\n\n**Tasks:**\n\n1. **Create documentation index (`docs/INDEX.md`)**\n   - Description: Comprehensive index of all documentation with descriptions and use cases\n   - Acceptance Criteria:\n     - Lists all documentation files with one-line descriptions\n     - Organized by category matching directory structure\n     - Includes \"When to read this\" guidance for each doc\n     - Links work correctly from root directory\n\n2. **Enhance CLAUDE.md as main entry point**\n   - Description: Update CLAUDE.md to focus on quick reference and point to detailed docs\n   - Acceptance Criteria:\n     - Quick Reference section remains intact\n     - Architecture overview points to `docs/architecture/` for details\n     - Module section links to individual module docs\n     - Add \"For detailed information, see...\" sections throughout\n     - Add link to `docs/INDEX.md` at top\n\n3. **Create documentation structure**\n   - Description: Create all directory structure and placeholder files\n   - Acceptance Criteria:\n     - All directories from proposed structure created\n     - Each directory has a README.md explaining its purpose\n     - Placeholder `.md` files created with headers and TODO sections\n\n### Phase 2: Core Service Documentation (Critical Context)\n\n**Goal:** Document the core orchestrator components that are frequently modified\n\n**Tasks:**\n\n1. **Document agent loop (`docs/core/agent-loop.md`)**\n   - Description: Deep dive into the agent reasoning cycle\n   - Acceptance Criteria:\n     - Explain each of the 9 steps in detail\n     - Code references to `agent/core/orchestrator/agent_loop.py` with line numbers\n     - Diagram of iteration flow\n     - Examples of tool use cycles\n     - User resolution and permission checking details\n     - Budget tracking implementation\n\n2. **Document tool registry (`docs/core/tool-registry.md`)**\n   - Description: Module discovery and tool routing internals\n   - Acceptance Criteria:\n     - Discovery process on startup\n     - Redis caching strategy\n     - Permission filtering logic\n     - Tool name routing (splitting on `.`)\n     - Manifest validation\n     - Error handling for unreachable modules\n     - Code references to `agent/core/orchestrator/tool_registry.py`\n\n3. **Document LLM router (`docs/core/llm-router.md`)**\n   - Description: Provider abstraction and fallback mechanism\n   - Acceptance Criteria:\n     - Provider registration system\n     - Fallback chain logic\n     - Request/response normalization\n     - Token counting per provider\n     - Error handling and retry logic\n     - Adding new providers guide (cross-reference to features/)\n     - Code references to `agent/core/llm_router/router.py`\n\n4. **Document context builder (`docs/core/context-builder.md`)**\n   - Description: How context is assembled for LLM calls\n   - Acceptance Criteria:\n     - System prompt construction\n     - Persona integration\n     - Memory retrieval (semantic + summary)\n     - Conversation history windowing\n     - File attachment enrichment\n     - Token budget considerations\n     - Active project injection\n\n5. **Document memory system (`docs/core/memory-system.md`)**\n   - Description: Summarization and semantic recall\n   - Acceptance Criteria:\n     - When conversations are summarized\n     - Embedding generation via `/embed` endpoint\n     - Vector similarity search with pgvector\n     - Memory creation from summaries\n     - Recall scoring and ranking\n     - Code references to `agent/core/memory/`\n\n6. **Create core overview (`docs/core/overview.md`)**\n   - Description: High-level core service architecture\n   - Acceptance Criteria:\n     - Component diagram\n     - Request lifecycle\n     - Dependencies between components\n     - Key files and their purposes\n     - Links to detailed component docs\n\n### Phase 3: Communication Layer Documentation\n\n**Goal:** Document bot implementations and platform integration patterns\n\n**Tasks:**\n\n1. **Document Discord bot (`docs/comms/discord-bot.md`)**\n   - Description: Discord.py implementation details\n   - Acceptance Criteria:\n     - Event handlers (on_message, on_ready)\n     - Attachment download and upload\n     - Message formatting (embed vs plain text)\n     - Thread handling\n     - Rate limiting considerations\n     - Code references to `agent/comms/discord_bot/bot.py`\n\n2. **Document Telegram bot (`docs/comms/telegram-bot.md`)**\n   - Description: python-telegram-bot implementation\n   - Acceptance Criteria:\n     - Update handlers\n     - File handling (documents, photos, voice)\n     - Keyboard markup formatting\n     - Group vs private chat handling\n     - Code references to `agent/comms/telegram_bot/bot.py`\n\n3. **Document Slack bot (`docs/comms/slack-bot.md`)**\n   - Description: slack-bolt implementation\n   - Acceptance Criteria:\n     - Socket mode setup\n     - Event subscriptions\n     - File upload/download via API\n     - Thread handling\n     - App mentions vs DMs\n     - Code references to `agent/comms/slack_bot/bot.py`\n\n4. **Document file pipeline (`docs/comms/file-pipeline.md`)**\n   - Description: End-to-end file handling across platforms\n   - Acceptance Criteria:\n     - User upload flow (bot \u2192 MinIO \u2192 core \u2192 DB)\n     - Agent generation flow (module \u2192 MinIO \u2192 DB \u2192 bot)\n     - File enrichment in user messages\n     - MinIO bucket policy setup\n     - Public URL generation\n     - Security considerations\n\n5. **Create comms overview (`docs/comms/overview.md`)**\n   - Description: Common bot architecture patterns\n   - Acceptance Criteria:\n     - IncomingMessage normalization\n     - AgentResponse formatting\n     - Error handling patterns\n     - Restart behavior on missing tokens\n     - Adding new platform guide (cross-reference to features/)\n\n### Phase 4: Enhanced Module Documentation\n\n**Goal:** Expand all module docs to include implementation details and troubleshooting\n\n**Tasks:**\n\n1. **Enhance research module docs**\n   - Description: Add implementation details to `docs/modules/research.md`\n   - Acceptance Criteria:\n     - DuckDuckGo API usage and rate limits\n     - BeautifulSoup parsing strategy\n     - Summarization flow (calls core /message)\n     - Error handling for network failures\n     - Testing approach\n\n2. **Enhance file_manager module docs**\n   - Description: Add MinIO details to `docs/modules/file_manager.md`\n   - Acceptance Criteria:\n     - MinIO client initialization\n     - Bucket creation and policy setting\n     - MIME type detection logic\n     - Filename sanitization rules\n     - File size limits\n     - Integration with code_executor\n\n3. **Enhance code_executor module docs**\n   - Description: Add security model to `docs/modules/code_executor.md`\n   - Acceptance Criteria:\n     - Subprocess sandboxing approach\n     - Shell command blocklist\n     - Installed packages (numpy, pandas, matplotlib, etc.)\n     - File detection and auto-upload\n     - Timeout handling\n     - Security considerations\n\n4. **Enhance knowledge module docs**\n   - Description: Add embedding flow to `docs/modules/knowledge.md`\n   - Acceptance Criteria:\n     - Memory creation workflow\n     - Embedding generation via core `/embed`\n     - Vector similarity search SQL\n     - Memory management (forgetting)\n     - User isolation\n\n5. **Enhance claude_code module docs**\n   - Description: Add Docker-in-Docker details to `docs/modules/claude_code.md`\n   - Acceptance Criteria:\n     - Docker socket mounting\n     - Container lifecycle management\n     - Workspace persistence\n     - Task state machine\n     - Plan/execute mode flow\n     - Continuation mechanism\n     - Git integration details\n\n6. **Enhance deployer module docs**\n   - Description: Add project detection to `docs/modules/deployer.md`\n   - Acceptance Criteria:\n     - Project type detection logic\n     - Docker build process\n     - Port allocation\n     - Environment variable injection\n     - Log streaming\n     - Teardown cleanup\n\n7. **Enhance scheduler module docs**\n   - Description: Add workflow chaining examples to `docs/modules/scheduler.md`\n   - Acceptance Criteria:\n     - Job types (poll_module, poll_url, delay)\n     - Resume conversation mechanism\n     - Interval and max attempts\n     - Success/failure callbacks\n     - Example workflows (claude_code \u2192 deployer)\n\n8. **Enhance location module docs**\n   - Description: Add OwnTracks protocol to `docs/modules/location.md`\n   - Acceptance Criteria:\n     - OwnTracks HTTP endpoint\n     - Region sync to device\n     - Geofence trigger logic\n     - Credential generation\n     - Named places\n\n9. **Enhance remaining modules**\n   - Description: Add authentication and API details to garmin, renpho, myfitnesspal\n   - Acceptance Criteria:\n     - OAuth/API key flows\n     - Request/response examples\n     - Rate limiting\n     - Error handling\n\n10. **Move and enhance ADDING_MODULES.md**\n    - Description: Move to `docs/modules/` and add more examples\n    - Acceptance Criteria:\n      - Update all references in other docs\n      - Add troubleshooting section\n      - Add more complete working examples\n      - Add testing section\n\n11. **Enhance modules overview**\n    - Description: Add discovery flow diagrams to `docs/modules/overview.md`\n    - Acceptance Criteria:\n      - Sequence diagram of discovery\n      - Execution flow diagram\n      - Permission filtering visualization\n      - Cross-module workflow examples\n\n### Phase 5: Feature Implementation Guides\n\n**Goal:** Create step-by-step guides for common development tasks\n\n**Tasks:**\n\n1. **Create adding-llm-provider guide (`docs/features/adding-llm-provider.md`)**\n   - Description: Complete guide to adding a new LLM provider\n   - Acceptance Criteria:\n     - Create provider class in `llm_router/providers/`\n     - Implement BaseLLMProvider interface\n     - Normalize responses\n     - Add to router registration\n     - Update config settings\n     - Testing the integration\n     - Full working example\n\n2. **Create adding-platform-bot guide (`docs/features/adding-platform-bot.md`)**\n   - Description: Guide to integrating a new chat platform\n   - Acceptance Criteria:\n     - Bot structure and dependencies\n     - Message normalization\n     - File handling\n     - Response formatting\n     - Docker service setup\n     - Testing with core\n\n3. **Create adding-database-table guide (`docs/features/adding-database-table.md`)**\n   - Description: Step-by-step database schema changes\n   - Acceptance Criteria:\n     - Create model in shared/models/\n     - Relationship patterns (FK, back_populates)\n     - Alembic migration creation\n     - Migration testing\n     - Rollback procedures\n     - Example with multiple tables\n\n4. **Create implementing-workflows guide (`docs/features/implementing-workflows.md`)**\n   - Description: Multi-module workflow patterns\n   - Acceptance Criteria:\n     - Scheduler-based workflows\n     - Error handling between steps\n     - State management\n     - Examples: claude_code \u2192 deployer, research \u2192 knowledge\n     - Resume conversation pattern\n\n5. **Create file-generation guide (`docs/features/file-generation.md`)**\n   - Description: How modules create and return files\n   - Acceptance Criteria:\n     - Upload to MinIO\n     - Create FileRecord\n     - Return in ToolResult\n     - Orchestrator extraction\n     - Bot download and display\n\n6. **Create background-jobs guide (`docs/features/background-jobs.md`)**\n   - Description: Scheduler integration patterns\n   - Acceptance Criteria:\n     - Job types and use cases\n     - Creating polling jobs\n     - Resume conversation mechanism\n     - Timeout and retry handling\n     - Notification patterns\n\n7. **Create authentication guide (`docs/features/authentication.md`)**\n   - Description: External API authentication patterns\n   - Acceptance Criteria:\n     - OAuth 2.0 flow\n     - API key management\n     - Token refresh\n     - Per-user credentials storage\n     - Example implementations (Garmin, Atlassian)\n\n8. **Create testing-modules guide (`docs/features/testing-modules.md`)**\n   - Description: Module testing strategies\n   - Acceptance Criteria:\n     - Unit testing tool methods\n     - Integration testing /execute endpoint\n     - Mocking dependencies\n     - Database fixtures\n     - Example test suite\n\n### Phase 6: API Reference Documentation\n\n**Goal:** Create comprehensive reference for schemas, models, and APIs\n\n**Tasks:**\n\n1. **Create shared-schemas reference (`docs/api-reference/shared-schemas.md`)**\n   - Description: Document all Pydantic schemas in shared/schemas/\n   - Acceptance Criteria:\n     - ToolCall, ToolResult, ModuleManifest\n     - IncomingMessage, AgentResponse\n     - ToolDefinition, ToolParameter\n     - Field descriptions and types\n     - Validation rules\n     - Usage examples\n\n2. **Create database-models reference (`docs/api-reference/database-models.md`)**\n   - Description: Complete ORM model reference\n   - Acceptance Criteria:\n     - All models with field descriptions\n     - Relationship diagrams\n     - Unique constraints and indexes\n     - Cascade behaviors\n     - Query examples for common operations\n\n3. **Create core-endpoints reference (`docs/api-reference/core-endpoints.md`)**\n   - Description: Core service HTTP and WebSocket endpoints\n   - Acceptance Criteria:\n     - POST /message\n     - POST /embed\n     - POST /continue\n     - GET /health\n     - Request/response schemas\n     - Error codes\n\n4. **Create module-contract reference (`docs/api-reference/module-contract.md`)**\n   - Description: Specification for module endpoints\n   - Acceptance Criteria:\n     - GET /manifest spec\n     - POST /execute spec\n     - GET /health spec\n     - Timeout expectations\n     - Error response format\n\n5. **Create shared-utilities reference (`docs/api-reference/shared-utilities.md`)**\n   - Description: Document shared package utilities\n   - Acceptance Criteria:\n     - get_settings() and config\n     - get_session_factory() usage\n     - get_redis() usage\n     - parse_list() helper\n     - upload_attachment() from file_utils\n     - Logging with structlog\n\n### Phase 7: Architecture Documentation\n\n**Goal:** Create comprehensive architecture documentation\n\n**Tasks:**\n\n1. **Create architecture overview (`docs/architecture/overview.md`)**\n   - Description: High-level system design\n   - Acceptance Criteria:\n     - Component diagram\n     - Service dependencies\n     - Network topology (agent-net)\n     - Technology stack\n     - Design decisions and rationale\n\n2. **Create data-flow documentation (`docs/architecture/data-flow.md`)**\n   - Description: Request/response lifecycle with diagrams\n   - Acceptance Criteria:\n     - User message \u2192 agent response flow\n     - Tool execution flow\n     - File upload flow\n     - Background job flow\n     - Memory creation and recall flow\n     - Sequence diagrams\n\n3. **Create database-schema documentation (`docs/architecture/database-schema.md`)**\n   - Description: Complete schema with relationships\n   - Acceptance Criteria:\n     - ERD diagram (can be ASCII or mermaid)\n     - Table-by-table descriptions\n     - Relationship explanations\n     - Index strategy\n     - Migration history approach\n\n4. **Create module-system documentation (`docs/architecture/module-system.md`)**\n   - Description: Module architecture design\n   - Acceptance Criteria:\n     - Why microservices\n     - Discovery mechanism\n     - Routing strategy\n     - Isolation benefits\n     - Shared package approach\n     - Performance considerations\n\n5. **Create deployment documentation (`docs/architecture/deployment.md`)**\n   - Description: Docker Compose infrastructure\n   - Acceptance Criteria:\n     - Service definitions\n     - Network configuration\n     - Volume mounts\n     - Environment variables\n     - Startup order and dependencies\n     - Health checks\n\n### Phase 8: Development and Deployment Documentation\n\n**Goal:** Support developers and operators\n\n**Tasks:**\n\n1. **Create getting-started guide (`docs/development/getting-started.md`)**\n   - Description: Onboarding for new developers\n   - Acceptance Criteria:\n     - Prerequisites\n     - First-time setup\n     - Creating first module (tutorial)\n     - Development workflow\n     - Common commands\n\n2. **Create testing guide (`docs/development/testing.md`)**\n   - Description: Testing strategies and tools\n   - Acceptance Criteria:\n     - Unit testing approach\n     - Integration testing\n     - Database fixtures\n     - Mocking external APIs\n     - Running tests in Docker\n\n3. **Create debugging guide (`docs/development/debugging.md`)**\n   - Description: Problem diagnosis techniques\n   - Acceptance Criteria:\n     - Log analysis with structlog\n     - Using make shell\n     - Database queries\n     - Redis inspection\n     - Network debugging\n\n4. **Create makefile-reference (`docs/development/makefile-reference.md`)**\n   - Description: All make targets explained\n   - Acceptance Criteria:\n     - Every target documented\n     - Grouped by category\n     - Use cases for each\n     - Examples\n\n5. **Create code-standards guide (`docs/development/code-standards.md`)**\n   - Description: Python conventions and best practices\n   - Acceptance Criteria:\n     - Type hints usage\n     - Async/await patterns\n     - Structlog usage\n     - Error handling patterns\n     - Naming conventions\n\n6. **Create production-setup guide (`docs/deployment/production-setup.md`)**\n   - Description: Production deployment guide\n   - Acceptance Criteria:\n     - Production docker-compose variations\n     - Reverse proxy setup (nginx)\n     - SSL/TLS configuration\n     - Environment separation\n     - Resource limits\n\n7. **Create secrets-management guide (`docs/deployment/secrets-management.md`)**\n   - Description: Handling API keys and credentials\n   - Acceptance Criteria:\n     - Environment variable best practices\n     - Secret rotation\n     - Per-user credential storage\n     - Encryption considerations\n\n8. **Create monitoring guide (`docs/deployment/monitoring.md`)**\n   - Description: Observability setup\n   - Acceptance Criteria:\n     - Log aggregation\n     - Metrics collection\n     - Alerting strategies\n     - Dashboard setup\n\n9. **Create backup-restore guide (`docs/deployment/backup-restore.md`)**\n   - Description: Data protection procedures\n   - Acceptance Criteria:\n     - PostgreSQL backup\n     - MinIO backup\n     - Restore procedures\n     - Disaster recovery\n\n### Phase 9: Troubleshooting Documentation\n\n**Goal:** Help diagnose and fix common issues\n\n**Tasks:**\n\n1. **Create common-issues guide (`docs/troubleshooting/common-issues.md`)**\n   - Description: FAQ and solutions\n   - Acceptance Criteria:\n     - Module discovery failures\n     - Permission errors\n     - Token budget exceeded\n     - Network connectivity issues\n     - Each with diagnosis and fix\n\n2. **Create module-issues guide (`docs/troubleshooting/module-issues.md`)**\n   - Description: Module-specific troubleshooting\n   - Acceptance Criteria:\n     - Module not responding\n     - Tool execution timeout\n     - Database connection failures\n     - MinIO access issues\n\n3. **Create platform-issues guide (`docs/troubleshooting/platform-issues.md`)**\n   - Description: Bot connection problems\n   - Acceptance Criteria:\n     - Bot not responding\n     - Authentication failures\n     - File upload/download issues\n     - Rate limiting\n\n4. **Create database-issues guide (`docs/troubleshooting/database-issues.md`)**\n   - Description: Database and migration problems\n   - Acceptance Criteria:\n     - Migration failures\n     - Alembic conflicts\n     - Connection pool exhaustion\n     - Slow queries\n\n5. **Create performance guide (`docs/troubleshooting/performance.md`)**\n   - Description: Performance debugging\n   - Acceptance Criteria:\n     - Slow agent responses\n     - High memory usage\n     - Database query optimization\n     - Redis cache tuning\n\n### Phase 10: Documentation Polish and Cross-Linking\n\n**Goal:** Ensure all documentation is interconnected and complete\n\n**Tasks:**\n\n1. **Add cross-references throughout documentation**\n   - Description: Link related docs to each other\n   - Acceptance Criteria:\n     - Every doc links to related docs\n     - CLAUDE.md links to all detailed docs\n     - Module docs link to feature guides\n     - Feature guides link to API reference\n     - No dead links\n\n2. **Add \"Quick Context\" sections to all docs**\n   - Description: Each doc starts with quick context box\n   - Acceptance Criteria:\n     - Related files section\n     - Related docs section\n     - Key concepts section\n     - When to read this doc\n\n3. **Create diagrams for complex flows**\n   - Description: Add mermaid diagrams where helpful\n   - Acceptance Criteria:\n     - Agent loop flow diagram\n     - Tool execution sequence diagram\n     - Memory retrieval flow\n     - File pipeline flow\n     - Workflow chaining examples\n\n4. **Add code examples throughout**\n   - Description: Every guide has working code examples\n   - Acceptance Criteria:\n     - Copy-paste ready examples\n     - Full context provided\n     - Comments explaining key points\n     - Error handling shown\n\n5. **Update CLAUDE.md with new structure**\n   - Description: Revise CLAUDE.md to be a true entry point\n   - Acceptance Criteria:\n     - Quick reference remains\n     - Links to detailed docs for each section\n     - \"For detailed X, see docs/Y\" throughout\n     - Architecture ASCII art links to docs/architecture/\n\n6. **Create docs/README.md**\n   - Description: Documentation directory overview\n   - Acceptance Criteria:\n     - Explains directory structure\n     - Links to INDEX.md\n     - Quick navigation guide\n     - Contribution guidelines\n\n## Success Criteria\n\n### For AI Agents Working on Features\n\n1. **Context acquisition < 3 file reads**: Agent can find relevant documentation in \u22643 file reads for any common task\n2. **Self-contained docs**: Each document provides enough context to understand its scope without reading others\n3. **Code references**: Documentation includes file paths and line numbers for code examples\n4. **Examples for every pattern**: Common patterns have complete working examples\n\n### For Human Developers\n\n1. **Onboarding time**: New developer can create a working module in <2 hours with docs alone\n2. **Troubleshooting success**: Common issues can be diagnosed using troubleshooting docs\n3. **Architecture understanding**: System design is clear from architecture docs\n4. **Navigation**: Can find any information in <2 clicks from CLAUDE.md or INDEX.md\n\n### For Documentation Maintenance\n\n1. **Update locations are obvious**: When code changes, it's clear which docs need updates\n2. **No duplication**: Each concept documented in one place, referenced elsewhere\n3. **Versioning**: Documentation changes tracked in git alongside code\n4. **Completeness**: Every module, feature, and component has documentation\n\n## Implementation Notes\n\n### Tooling\n\n- **Diagrams**: Use mermaid.js syntax (supported by GitHub, many renderers)\n- **Code blocks**: Always specify language for syntax highlighting\n- **Tables**: Use markdown tables for structured data\n- **Links**: Use relative paths from repository root\n\n### Writing Style\n\n- **Concise**: Short paragraphs, bullet points\n- **Imperative**: \"Create file X\" not \"You should create file X\"\n- **Specific**: Include actual code, not pseudocode\n- **Progressive**: Overview first, details after\n- **Complete**: Include error cases, edge cases\n\n### Agent-Friendly Patterns\n\n- **Section headers are questions**: \"How does discovery work?\" not \"Discovery\"\n- **Tables for comparison**: When multiple options exist\n- **Code blocks with full context**: Include imports, not just functions\n- **File location in every doc**: State which files the doc describes\n- **Prerequisites explicit**: State what to read first\n\n### Maintenance Plan\n\nAfter initial creation:\n\n1. **Docs review in PRs**: Any code change that affects behavior requires doc update\n2. **Quarterly review**: Review INDEX.md quarterly to ensure completeness\n3. **Link checking**: Automated link checker in CI\n4. **Example testing**: Code examples should be testable (extract and run)\n\n## Migration Strategy\n\n### Phase 1 Implementation\n\nStart with most valuable docs for agents:\n\n1. Create INDEX.md (navigation hub)\n2. Core service docs (most frequently needed context)\n3. Enhanced module docs (agents work on modules often)\n4. Feature guides for common tasks\n\n### Gradual Enhancement\n\n- Existing docs remain valid, linked from new structure\n- New docs added incrementally by phase\n- CLAUDE.md remains comprehensive until Phase 10\n- No breaking changes to existing documentation\n\n### Validation\n\nAfter each phase:\n\n1. Test with AI agent: Can it find information quickly?\n2. Human review: Is it clear and accurate?\n3. Link check: All cross-references work\n4. Example verification: Code examples are correct\n\n## File Inventory\n\n### Files to Create (Estimated 60+ new files)\n\n**Phase 1**: 3 files (INDEX.md, directory READMEs)\n**Phase 2**: 6 files (core service docs)\n**Phase 3**: 5 files (comms layer docs)\n**Phase 4**: 11 files (enhanced module docs)\n**Phase 5**: 8 files (feature guides)\n**Phase 6**: 5 files (API reference)\n**Phase 7**: 5 files (architecture)\n**Phase 8**: 9 files (development & deployment)\n**Phase 9**: 5 files (troubleshooting)\n**Phase 10**: Enhancements to existing files\n\n### Files to Enhance\n\n- CLAUDE.md (add links to detailed docs)\n- All existing module docs (add implementation details)\n- README.md (minor updates for consistency)\n\n### Files to Move\n\n- agent/docs/ADDING_MODULES.md \u2192 agent/docs/modules/ADDING_MODULES.md\n- agent/docs/portal.md \u2192 agent/docs/modules/portal.md (treat portal as a module)\n\n## Estimated Effort\n\n### By Phase (Story Points using Fibonacci)\n\n- **Phase 1**: 3 points (infrastructure)\n- **Phase 2**: 13 points (core docs, most complex)\n- **Phase 3**: 8 points (comms layer)\n- **Phase 4**: 21 points (11 module enhancements)\n- **Phase 5**: 13 points (feature guides)\n- **Phase 6**: 8 points (API reference)\n- **Phase 7**: 8 points (architecture)\n- **Phase 8**: 13 points (dev & deployment)\n- **Phase 9**: 8 points (troubleshooting)\n- **Phase 10**: 5 points (polish)\n\n**Total**: ~100 story points\n\n### Priority Order for Incremental Value\n\nIf implementing incrementally, prioritize:\n\n1. **Phase 1** (foundation)\n2. **Phase 2** (core docs - highest value for agents)\n3. **Phase 4** (module enhancements)\n4. **Phase 5** (feature guides)\n5. **Phase 3** (comms layer)\n6. **Phase 6** (API reference)\n7. **Phases 7-9** (architecture, dev, troubleshooting)\n8. **Phase 10** (polish)\n\n## Conclusion\n\nThis plan transforms the documentation from a collection of scattered references into a comprehensive, navigable knowledge base optimized for both AI agents and human developers. The hierarchical structure, progressive disclosure, and extensive cross-linking will dramatically reduce context acquisition time and improve development velocity.\n\nThe phased approach allows for incremental implementation while maintaining the value of existing documentation. Each phase delivers standalone value, and the system remains functional throughout the migration.\n"
  },
  "error": null
}