<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Portal</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3346;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --accent: #6c8cff;
    --green: #4ade80;
    --yellow: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.5;
  }
  .header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header-nav { display: flex; gap: 12px; align-items: center; }
  .header-nav a {
    color: var(--text-dim); text-decoration: none; font-size: 13px;
    padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface2);
  }
  .header-nav a:hover { background: var(--border); color: var(--text); }
  .container { max-width: 1280px; margin: 0 auto; padding: 20px; }

  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
  .tab {
    padding: 8px 20px; border-radius: 8px 8px 0 0; cursor: pointer;
    background: var(--surface2); border: 1px solid var(--border); border-bottom: none;
    color: var(--text-dim); font-size: 14px; font-weight: 500;
  }
  .tab.active { background: var(--surface); color: var(--text); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Tables */
  .table-wrap {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    overflow-x: auto;
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    text-align: left; padding: 10px 14px; background: var(--surface2);
    color: var(--text-dim); font-weight: 500; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
  }
  td { padding: 10px 14px; border-top: 1px solid var(--border); }
  tr:hover td { background: var(--surface2); }

  /* Tags */
  .tag {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 500;
  }
  .tag-owner { background: #6c8cff22; color: var(--accent); }
  .tag-admin { background: #fbbf2422; color: var(--yellow); }
  .tag-user { background: #4ade8022; color: var(--green); }
  .tag-guest { background: #8b90a022; color: var(--text-dim); }
  .tag-discord { background: #5865f222; color: #7289da; }
  .tag-telegram { background: #229ed922; color: #29b6f6; }
  .tag-slack { background: #4a154b22; color: #e01e5a; }

  /* Buttons */
  .btn {
    padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;
    border: 1px solid var(--border); font-family: inherit;
  }
  .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-primary:hover { opacity: 0.9; }
  .btn-danger { background: transparent; color: var(--red); border-color: var(--red); }
  .btn-danger:hover { background: #f8717122; }
  .btn-sm { padding: 3px 10px; font-size: 12px; }
  .btn-ghost { background: transparent; color: var(--text-dim); }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); }

  /* Forms */
  .form-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 20px; margin-bottom: 20px;
  }
  .form-card h3 { font-size: 15px; margin-bottom: 16px; font-weight: 600; }
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-group label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .form-group input, .form-group select, .form-group textarea {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 12px; color: var(--text); font-size: 13px; font-family: inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none; border-color: var(--accent);
  }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-actions { margin-top: 16px; display: flex; gap: 8px; }

  /* Section header */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .section-header h2 { font-size: 16px; font-weight: 600; }
  .badge {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 2px 10px; border-radius: 12px; font-size: 12px; color: var(--text-dim);
  }

  /* Modal */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px; min-width: 400px; max-width: 600px; width: 90%;
    max-height: 90vh; overflow-y: auto;
  }
  .modal h3 { font-size: 16px; margin-bottom: 16px; }
  .modal .form-actions { justify-content: flex-end; }

  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
  .text-right { text-align: right; }
  .text-dim { color: var(--text-dim); }
  .toast {
    position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
    font-size: 13px; z-index: 200; animation: fadeIn 0.2s;
  }
  .toast-success { background: #065f46; color: var(--green); border: 1px solid var(--green); }
  .toast-error { background: #7f1d1d; color: var(--red); border: 1px solid var(--red); }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }

  .expand-row { cursor: pointer; }
  .expand-row:hover td { background: var(--surface2); }
  .detail-row td { padding: 0; background: var(--bg); }
  .detail-content { padding: 12px 14px; }
  .platform-chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .platform-chip {
    display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px;
    border-radius: 6px; background: var(--surface2); border: 1px solid var(--border);
    font-size: 12px;
  }
  .platform-chip .remove { cursor: pointer; color: var(--red); font-weight: bold; }
  .platform-chip .remove:hover { opacity: 0.7; }
</style>
</head>
<body>

<div class="header">
  <h1>Admin Portal</h1>
  <div class="header-nav">
    <a href="/">Dashboard</a>
  </div>
</div>

<div class="container">
  <div class="tabs">
    <div class="tab active" onclick="switchTab('users')">Users</div>
    <div class="tab" onclick="switchTab('personas')">Personas</div>
  </div>

  <!-- ===== USERS TAB ===== -->
  <div id="tab-users" class="tab-content active">
    <div class="form-card">
      <h3>Create User</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Permission Level</label>
          <select id="new-user-role">
            <option value="guest">guest</option>
            <option value="user">user</option>
            <option value="admin">admin</option>
            <option value="owner">owner</option>
          </select>
        </div>
        <div class="form-group">
          <label>Monthly Token Budget</label>
          <input type="number" id="new-user-budget" placeholder="Leave empty for unlimited">
        </div>
        <div class="form-group">
          <label>Platform</label>
          <select id="new-user-platform">
            <option value="">No platform link</option>
            <option value="discord">Discord</option>
            <option value="telegram">Telegram</option>
            <option value="slack">Slack</option>
          </select>
        </div>
        <div class="form-group">
          <label>Platform User ID</label>
          <input type="text" id="new-user-platform-id" placeholder="e.g. 123456789">
        </div>
        <div class="form-group">
          <label>Platform Username</label>
          <input type="text" id="new-user-platform-name" placeholder="Optional display name">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="createUser()">Create User</button>
      </div>
    </div>

    <div class="section-header">
      <h2>Users</h2>
      <span class="badge" id="user-count">-</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>User</th>
          <th>Platforms</th>
          <th>Role</th>
          <th class="text-right">Budget</th>
          <th class="text-right">Used (Month)</th>
          <th>Created</th>
          <th>Actions</th>
        </tr></thead>
        <tbody id="users-body"><tr><td colspan="7" class="text-dim" style="text-align:center;padding:24px">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ===== PERSONAS TAB ===== -->
  <div id="tab-personas" class="tab-content">
    <div class="form-card">
      <h3>Create Persona</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="new-persona-name" placeholder="Persona name">
        </div>
        <div class="form-group">
          <label>Platform (optional)</label>
          <select id="new-persona-platform">
            <option value="">Global (all platforms)</option>
            <option value="discord">Discord</option>
            <option value="telegram">Telegram</option>
            <option value="slack">Slack</option>
          </select>
        </div>
        <div class="form-group">
          <label>Server ID (optional)</label>
          <input type="text" id="new-persona-server" placeholder="Platform server/guild ID">
        </div>
        <div class="form-group">
          <label>Default Model (optional)</label>
          <input type="text" id="new-persona-model" placeholder="e.g. claude-sonnet-4-20250514">
        </div>
        <div class="form-group">
          <label>Max Tokens / Request</label>
          <input type="number" id="new-persona-max-tokens" value="4000">
        </div>
        <div class="form-group">
          <label>Default?</label>
          <select id="new-persona-default">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
      <div class="form-group" style="margin-top:12px">
        <label>Allowed Modules (JSON array)</label>
        <input type="text" id="new-persona-modules" value='["research", "file_manager", "code_executor"]'>
      </div>
      <div class="form-group" style="margin-top:12px">
        <label>System Prompt</label>
        <textarea id="new-persona-prompt" rows="4" placeholder="Enter the system prompt for this persona..."></textarea>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="createPersona()">Create Persona</button>
      </div>
    </div>

    <div class="section-header">
      <h2>Personas</h2>
      <span class="badge" id="persona-count">-</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Name</th>
          <th>Platform</th>
          <th>Server ID</th>
          <th>Model</th>
          <th class="text-right">Max Tokens</th>
          <th>Modules</th>
          <th>Default</th>
          <th>Created</th>
          <th>Actions</th>
        </tr></thead>
        <tbody id="personas-body"><tr><td colspan="9" class="text-dim" style="text-align:center;padding:24px">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('edit-user-modal')">
  <div class="modal">
    <h3>Edit User</h3>
    <input type="hidden" id="edit-user-id">
    <div class="form-grid">
      <div class="form-group">
        <label>Permission Level</label>
        <select id="edit-user-role">
          <option value="guest">guest</option>
          <option value="user">user</option>
          <option value="admin">admin</option>
          <option value="owner">owner</option>
        </select>
      </div>
      <div class="form-group">
        <label>Monthly Token Budget</label>
        <input type="number" id="edit-user-budget" placeholder="Empty = unlimited">
      </div>
    </div>
    <h3 style="margin-top:16px;font-size:14px">Platform Links</h3>
    <div id="edit-user-platforms" style="margin:10px 0"></div>
    <div class="form-grid" style="margin-top:8px">
      <div class="form-group">
        <label>Add Platform</label>
        <select id="edit-link-platform">
          <option value="discord">Discord</option>
          <option value="telegram">Telegram</option>
          <option value="slack">Slack</option>
        </select>
      </div>
      <div class="form-group">
        <label>Platform User ID</label>
        <input type="text" id="edit-link-id" placeholder="ID">
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="edit-link-name" placeholder="Optional">
      </div>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-sm btn-ghost" onclick="addLinkFromModal()">+ Add Link</button>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('edit-user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveUser()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Edit Persona Modal -->
<div id="edit-persona-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('edit-persona-modal')">
  <div class="modal">
    <h3>Edit Persona</h3>
    <input type="hidden" id="edit-persona-id">
    <div class="form-grid">
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="edit-persona-name">
      </div>
      <div class="form-group">
        <label>Platform</label>
        <select id="edit-persona-platform">
          <option value="">Global</option>
          <option value="discord">Discord</option>
          <option value="telegram">Telegram</option>
          <option value="slack">Slack</option>
        </select>
      </div>
      <div class="form-group">
        <label>Server ID</label>
        <input type="text" id="edit-persona-server">
      </div>
      <div class="form-group">
        <label>Default Model</label>
        <input type="text" id="edit-persona-model">
      </div>
      <div class="form-group">
        <label>Max Tokens / Request</label>
        <input type="number" id="edit-persona-max-tokens">
      </div>
      <div class="form-group">
        <label>Default?</label>
        <select id="edit-persona-default">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>
    <div class="form-group" style="margin-top:12px">
      <label>Allowed Modules (JSON array)</label>
      <input type="text" id="edit-persona-modules">
    </div>
    <div class="form-group" style="margin-top:12px">
      <label>System Prompt</label>
      <textarea id="edit-persona-prompt" rows="6"></textarea>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('edit-persona-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="savePersona()">Save Changes</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ---- Helpers ----
const roleTag = r => `<span class="tag tag-${r}">${r}</span>`;
const platformTag = p => `<span class="tag tag-${p}">${p}</span>`;
const fmtDate = iso => {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + ' ' +
         d.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'});
};
const fmt = n => n == null ? '-' : Number(n).toLocaleString();

function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

async function api(url, method='GET', body=null) {
  const opts = {method, headers: {'Content-Type':'application/json'}};
  if (body) opts.body = JSON.stringify(body);
  const resp = await fetch(url, opts);
  const data = await resp.json();
  if (!resp.ok) {
    throw new Error(data.detail || JSON.stringify(data));
  }
  return data;
}

// ---- Tabs ----
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab-content#tab-${name}`).classList.add('active');
  event.target.classList.add('active');
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// ---- Users ----
let usersCache = [];

async function loadUsers() {
  try {
    usersCache = await api('/api/admin/users');
    document.getElementById('user-count').textContent = usersCache.length;
    const body = document.getElementById('users-body');
    if (!usersCache.length) {
      body.innerHTML = '<tr><td colspan="7" class="text-dim" style="text-align:center;padding:24px">No users yet</td></tr>';
      return;
    }
    body.innerHTML = usersCache.map(u => {
      const name = u.platforms.length
        ? u.platforms.map(p => p.platform_username || p.platform_user_id).join(', ')
        : u.id.slice(0, 8) + '...';
      const plats = u.platforms.map(p => platformTag(p.platform)).join(' ') || '<span class="text-dim">none</span>';
      const budget = u.token_budget_monthly == null ? '<span class="text-dim">unlimited</span>' : fmt(u.token_budget_monthly);
      return `<tr>
        <td><strong class="mono">${name}</strong><br><span class="text-dim mono" style="font-size:11px">${u.id.slice(0,8)}</span></td>
        <td>${plats}</td>
        <td>${roleTag(u.permission_level)}</td>
        <td class="text-right mono">${budget}</td>
        <td class="text-right mono">${fmt(u.tokens_used_this_month)}</td>
        <td class="text-dim">${fmtDate(u.created_at)}</td>
        <td>
          <button class="btn btn-sm btn-ghost" onclick="editUser('${u.id}')">Edit</button>
          <button class="btn btn-sm btn-ghost" onclick="resetBudget('${u.id}')" title="Reset monthly tokens">Reset</button>
          <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
        </td>
      </tr>`;
    }).join('');
  } catch(e) { console.error('loadUsers', e); }
}

async function createUser() {
  const role = document.getElementById('new-user-role').value;
  const budgetVal = document.getElementById('new-user-budget').value;
  const budget = budgetVal ? parseInt(budgetVal) : null;
  const platform = document.getElementById('new-user-platform').value;
  const platformId = document.getElementById('new-user-platform-id').value;
  const platformName = document.getElementById('new-user-platform-name').value;

  try {
    const user = await api('/api/admin/users', 'POST', {
      permission_level: role,
      token_budget_monthly: budget,
    });
    // Add platform link if specified
    if (platform && platformId) {
      await api(`/api/admin/users/${user.id}/links`, 'POST', {
        platform,
        platform_user_id: platformId,
        platform_username: platformName || null,
      });
    }
    toast('User created');
    // Reset form
    document.getElementById('new-user-budget').value = '';
    document.getElementById('new-user-platform').value = '';
    document.getElementById('new-user-platform-id').value = '';
    document.getElementById('new-user-platform-name').value = '';
    loadUsers();
  } catch(e) { toast(e.message, 'error'); }
}

function editUser(userId) {
  const u = usersCache.find(x => x.id === userId);
  if (!u) return;
  document.getElementById('edit-user-id').value = u.id;
  document.getElementById('edit-user-role').value = u.permission_level;
  document.getElementById('edit-user-budget').value = u.token_budget_monthly ?? '';
  renderPlatformChips(u.platforms);
  openModal('edit-user-modal');
}

function renderPlatformChips(platforms) {
  const container = document.getElementById('edit-user-platforms');
  if (!platforms.length) {
    container.innerHTML = '<span class="text-dim" style="font-size:12px">No platform links</span>';
    return;
  }
  container.innerHTML = '<div class="platform-chips">' + platforms.map(p =>
    `<div class="platform-chip">
      ${platformTag(p.platform)}
      <span class="mono">${p.platform_username || p.platform_user_id}</span>
      <span class="remove" onclick="removeLink('${p.id}')" title="Remove link">&times;</span>
    </div>`
  ).join('') + '</div>';
}

async function removeLink(linkId) {
  if (!confirm('Remove this platform link?')) return;
  try {
    await api(`/api/admin/links/${linkId}`, 'DELETE');
    toast('Link removed');
    const userId = document.getElementById('edit-user-id').value;
    await loadUsers();
    // Re-open modal with updated data
    editUser(userId);
  } catch(e) { toast(e.message, 'error'); }
}

async function addLinkFromModal() {
  const userId = document.getElementById('edit-user-id').value;
  const platform = document.getElementById('edit-link-platform').value;
  const platformId = document.getElementById('edit-link-id').value;
  const platformName = document.getElementById('edit-link-name').value;
  if (!platformId) { toast('Platform User ID is required', 'error'); return; }
  try {
    await api(`/api/admin/users/${userId}/links`, 'POST', {
      platform,
      platform_user_id: platformId,
      platform_username: platformName || null,
    });
    toast('Link added');
    document.getElementById('edit-link-id').value = '';
    document.getElementById('edit-link-name').value = '';
    await loadUsers();
    editUser(userId);
  } catch(e) { toast(e.message, 'error'); }
}

async function saveUser() {
  const userId = document.getElementById('edit-user-id').value;
  const role = document.getElementById('edit-user-role').value;
  const budgetVal = document.getElementById('edit-user-budget').value;
  const budget = budgetVal ? parseInt(budgetVal) : null;
  try {
    await api(`/api/admin/users/${userId}`, 'PUT', {
      permission_level: role,
      token_budget_monthly: budget,
    });
    toast('User updated');
    closeModal('edit-user-modal');
    loadUsers();
  } catch(e) { toast(e.message, 'error'); }
}

async function deleteUser(userId) {
  const u = usersCache.find(x => x.id === userId);
  const name = u?.platforms?.[0]?.platform_username || userId.slice(0, 8);
  if (!confirm(`Delete user "${name}"? This cannot be undone.`)) return;
  try {
    await api(`/api/admin/users/${userId}`, 'DELETE');
    toast('User deleted');
    loadUsers();
  } catch(e) { toast(e.message, 'error'); }
}

async function resetBudget(userId) {
  if (!confirm('Reset monthly token usage to 0?')) return;
  try {
    await api(`/api/admin/users/${userId}/reset-budget`, 'POST');
    toast('Budget reset');
    loadUsers();
  } catch(e) { toast(e.message, 'error'); }
}

// ---- Personas ----
let personasCache = [];

async function loadPersonas() {
  try {
    personasCache = await api('/api/personas');
    document.getElementById('persona-count').textContent = personasCache.length;
    const body = document.getElementById('personas-body');
    if (!personasCache.length) {
      body.innerHTML = '<tr><td colspan="9" class="text-dim" style="text-align:center;padding:24px">No personas yet</td></tr>';
      return;
    }
    body.innerHTML = personasCache.map(p => {
      let modules = '-';
      try { modules = JSON.parse(p.allowed_modules).join(', '); } catch(e) { modules = p.allowed_modules; }
      return `<tr>
        <td><strong>${p.name}</strong></td>
        <td>${p.platform ? platformTag(p.platform) : '<span class="text-dim">global</span>'}</td>
        <td class="mono text-dim">${p.platform_server_id || '-'}</td>
        <td class="mono">${p.default_model || '<span class="text-dim">default</span>'}</td>
        <td class="text-right mono">${fmt(p.max_tokens_per_request)}</td>
        <td class="text-dim" style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${modules}">${modules}</td>
        <td>${p.is_default ? '<span class="tag tag-user">default</span>' : ''}</td>
        <td class="text-dim">${fmtDate(p.created_at)}</td>
        <td>
          <button class="btn btn-sm btn-ghost" onclick="editPersona('${p.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deletePersona('${p.id}')">Delete</button>
        </td>
      </tr>`;
    }).join('');
  } catch(e) { console.error('loadPersonas', e); }
}

async function createPersona() {
  const name = document.getElementById('new-persona-name').value;
  const prompt = document.getElementById('new-persona-prompt').value;
  if (!name || !prompt) { toast('Name and System Prompt are required', 'error'); return; }

  const modules = document.getElementById('new-persona-modules').value;
  try { JSON.parse(modules); } catch(e) { toast('Allowed Modules must be valid JSON', 'error'); return; }

  try {
    await api('/api/admin/personas', 'POST', {
      name,
      system_prompt: prompt,
      platform: document.getElementById('new-persona-platform').value || null,
      platform_server_id: document.getElementById('new-persona-server').value || null,
      allowed_modules: modules,
      default_model: document.getElementById('new-persona-model').value || null,
      max_tokens_per_request: parseInt(document.getElementById('new-persona-max-tokens').value) || 4000,
      is_default: document.getElementById('new-persona-default').value === 'true',
    });
    toast('Persona created');
    document.getElementById('new-persona-name').value = '';
    document.getElementById('new-persona-prompt').value = '';
    document.getElementById('new-persona-server').value = '';
    document.getElementById('new-persona-model').value = '';
    loadPersonas();
  } catch(e) { toast(e.message, 'error'); }
}

async function editPersona(personaId) {
  try {
    const p = await api(`/api/admin/personas/${personaId}`);
    document.getElementById('edit-persona-id').value = p.id;
    document.getElementById('edit-persona-name').value = p.name;
    document.getElementById('edit-persona-platform').value = p.platform || '';
    document.getElementById('edit-persona-server').value = p.platform_server_id || '';
    document.getElementById('edit-persona-model').value = p.default_model || '';
    document.getElementById('edit-persona-max-tokens').value = p.max_tokens_per_request;
    document.getElementById('edit-persona-modules').value = p.allowed_modules;
    document.getElementById('edit-persona-prompt').value = p.system_prompt;
    document.getElementById('edit-persona-default').value = p.is_default ? 'true' : 'false';
    openModal('edit-persona-modal');
  } catch(e) { toast(e.message, 'error'); }
}

async function savePersona() {
  const id = document.getElementById('edit-persona-id').value;
  const modules = document.getElementById('edit-persona-modules').value;
  try { JSON.parse(modules); } catch(e) { toast('Allowed Modules must be valid JSON', 'error'); return; }

  try {
    await api(`/api/admin/personas/${id}`, 'PUT', {
      name: document.getElementById('edit-persona-name').value,
      system_prompt: document.getElementById('edit-persona-prompt').value,
      platform: document.getElementById('edit-persona-platform').value || null,
      platform_server_id: document.getElementById('edit-persona-server').value || null,
      allowed_modules: modules,
      default_model: document.getElementById('edit-persona-model').value || null,
      max_tokens_per_request: parseInt(document.getElementById('edit-persona-max-tokens').value) || 4000,
      is_default: document.getElementById('edit-persona-default').value === 'true',
    });
    toast('Persona updated');
    closeModal('edit-persona-modal');
    loadPersonas();
  } catch(e) { toast(e.message, 'error'); }
}

async function deletePersona(personaId) {
  const p = personasCache.find(x => x.id === personaId);
  if (!confirm(`Delete persona "${p?.name}"?`)) return;
  try {
    await api(`/api/admin/personas/${personaId}`, 'DELETE');
    toast('Persona deleted');
    loadPersonas();
  } catch(e) { toast(e.message, 'error'); }
}

// ---- Init ----
loadUsers();
loadPersonas();
</script>
</body>
</html>
