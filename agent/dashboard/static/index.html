<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Admin Dashboard</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3346;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --accent: #6c8cff;
    --green: #4ade80;
    --yellow: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.5;
  }
  .header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header .refresh { background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .header .refresh:hover { background: var(--border); }
  .container { max-width: 1280px; margin: 0 auto; padding: 20px; }

  /* Stats cards */
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px; margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px;
  }
  .stat-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card .value { font-size: 26px; font-weight: 700; margin-top: 4px; }
  .stat-card .sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

  /* Sections */
  .section { margin-bottom: 24px; }
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .section-header h2 { font-size: 16px; font-weight: 600; }
  .section-header .badge {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 2px 10px; border-radius: 12px; font-size: 12px; color: var(--text-dim);
  }

  /* Tables */
  .table-wrap {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    overflow: hidden;
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 14px; background: var(--surface2);
    color: var(--text-dim); font-weight: 500; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 10px 14px; border-top: 1px solid var(--border); }
  tr:hover td { background: var(--surface2); }

  /* Tags */
  .tag {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 500;
  }
  .tag-owner { background: #6c8cff22; color: var(--accent); }
  .tag-admin { background: #fbbf2422; color: var(--yellow); }
  .tag-user { background: #4ade8022; color: var(--green); }
  .tag-guest { background: #8b90a022; color: var(--text-dim); }

  .tag-healthy { background: #4ade8022; color: var(--green); }
  .tag-unhealthy { background: #f8717122; color: var(--red); }
  .tag-unreachable { background: #8b90a022; color: var(--text-dim); }

  .tag-discord { background: #5865f222; color: #7289da; }
  .tag-telegram { background: #229ed922; color: #29b6f6; }
  .tag-slack { background: #4a154b22; color: #e01e5a; }

  /* Two column layout */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  /* Bar chart */
  .bar-chart { padding: 16px; }
  .bar-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
  .bar-label { width: 160px; font-size: 12px; color: var(--text-dim); text-align: right;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0; }
  .bar-track { flex: 1; height: 22px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; background: var(--accent);
    display: flex; align-items: center; padding: 0 8px; font-size: 11px;
    font-weight: 500; min-width: fit-content; transition: width 0.4s ease; }
  .bar-value { width: 70px; font-size: 12px; text-align: right; flex-shrink: 0; }

  /* Loading */
  .loading { text-align: center; padding: 40px; color: var(--text-dim); }
  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
  .text-right { text-align: right; }
  .text-dim { color: var(--text-dim); }

  /* Progress bar for budget */
  .budget-bar { display: flex; align-items: center; gap: 8px; }
  .budget-track { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; }
  .budget-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .budget-pct { font-size: 11px; color: var(--text-dim); width: 36px; text-align: right; }
</style>
</head>
<body>

<div class="header">
  <h1>Agent Admin Dashboard</h1>
  <button class="refresh" onclick="loadAll()">Refresh</button>
</div>

<div class="container">
  <!-- Overview Stats -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card"><div class="label">Loading...</div></div>
  </div>

  <!-- System Health -->
  <div class="section">
    <div class="section-header"><h2>System Health</h2></div>
    <div class="table-wrap">
      <table><thead><tr>
        <th>Service</th><th>Status</th><th>Details</th>
      </tr></thead><tbody id="health-body"><tr><td colspan="3" class="loading">Loading...</td></tr></tbody></table>
    </div>
  </div>

  <div class="two-col">
    <!-- Token Usage by Model -->
    <div class="section">
      <div class="section-header"><h2>Tokens by Model</h2><span class="badge">Last 30 days</span></div>
      <div class="table-wrap" id="model-chart"><div class="loading">Loading...</div></div>
    </div>

    <!-- Tool Usage -->
    <div class="section">
      <div class="section-header"><h2>Tool Usage</h2></div>
      <div class="table-wrap" id="tool-chart"><div class="loading">Loading...</div></div>
    </div>
  </div>

  <div class="two-col">
    <!-- Platform Stats -->
    <div class="section">
      <div class="section-header"><h2>Platform Breakdown</h2></div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Platform</th><th class="text-right">Users</th><th class="text-right">Conversations</th><th class="text-right">Messages</th>
        </tr></thead><tbody id="platform-body"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Personas -->
    <div class="section">
      <div class="section-header"><h2>Personas</h2></div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Name</th><th>Platform</th><th class="text-right">Conversations</th><th>Default</th>
        </tr></thead><tbody id="persona-body"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="section">
    <div class="section-header"><h2>Users</h2><span class="badge" id="user-count">-</span></div>
    <div class="table-wrap">
      <table><thead><tr>
        <th>User</th><th>Platform</th><th>Role</th>
        <th class="text-right">Tokens (Month)</th><th>Budget Usage</th>
        <th class="text-right">Total Tokens</th><th class="text-right">Est. Cost</th>
        <th class="text-right">Convos</th><th>Joined</th>
      </tr></thead><tbody id="users-body"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody></table>
    </div>
  </div>

  <!-- Recent Conversations -->
  <div class="section">
    <div class="section-header"><h2>Recent Conversations</h2><span class="badge">Last 50</span></div>
    <div class="table-wrap">
      <table><thead><tr>
        <th>User</th><th>Platform</th><th class="text-right">Messages</th>
        <th class="text-right">Tool Calls</th><th>Started</th><th>Last Active</th><th>Summarized</th>
      </tr></thead><tbody id="convs-body"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody></table>
    </div>
  </div>
</div>

<script>
const fmt = (n) => n == null ? '-' : Number(n).toLocaleString();
const fmtCost = (n) => n == null ? '-' : '$' + Number(n).toFixed(4);
const fmtDate = (iso) => {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
         d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
};
const pctColor = (pct) => pct > 90 ? 'var(--red)' : pct > 70 ? 'var(--yellow)' : 'var(--green)';
const platformTag = (p) => `<span class="tag tag-${p}">${p}</span>`;
const roleTag = (r) => `<span class="tag tag-${r}">${r}</span>`;
const healthTag = (s) => `<span class="tag tag-${s}">${s}</span>`;

async function loadOverview() {
  try {
    const data = await (await fetch('/api/overview')).json();
    document.getElementById('stats-grid').innerHTML = `
      <div class="stat-card"><div class="label">Users</div><div class="value">${fmt(data.total_users)}</div></div>
      <div class="stat-card"><div class="label">Conversations</div><div class="value">${fmt(data.total_conversations)}</div>
        <div class="sub">${fmt(data.active_conversations_24h)} active (24h)</div></div>
      <div class="stat-card"><div class="label">Messages</div><div class="value">${fmt(data.total_messages)}</div></div>
      <div class="stat-card"><div class="label">Total Tokens</div><div class="value">${fmt(data.total_tokens)}</div>
        <div class="sub">${fmt(data.tokens_7d)} last 7 days</div></div>
      <div class="stat-card"><div class="label">Est. Cost</div><div class="value">${fmtCost(data.total_cost)}</div>
        <div class="sub">${fmtCost(data.cost_7d)} last 7 days</div></div>
      <div class="stat-card"><div class="label">Memories</div><div class="value">${fmt(data.total_memories)}</div></div>
      <div class="stat-card"><div class="label">Files</div><div class="value">${fmt(data.total_files)}</div></div>
    `;
  } catch(e) { console.error('overview', e); }
}

async function loadHealth() {
  try {
    const data = await (await fetch('/api/system-health')).json();
    const body = document.getElementById('health-body');
    body.innerHTML = Object.entries(data).map(([name, info]) => `
      <tr><td><strong>${name}</strong></td>
      <td>${healthTag(info.status)}</td>
      <td class="text-dim mono">${info.error || (info.status_code ? 'HTTP ' + info.status_code : 'OK')}</td></tr>
    `).join('');
  } catch(e) { console.error('health', e); }
}

async function loadTokenUsage() {
  try {
    const data = await (await fetch('/api/token-usage')).json();
    const el = document.getElementById('model-chart');
    if (!data.by_model.length) { el.innerHTML = '<div class="loading">No token usage data yet</div>'; return; }
    const max = Math.max(...data.by_model.map(m => m.total_tokens));
    el.innerHTML = '<div class="bar-chart">' + data.by_model.map(m => {
      const pct = max > 0 ? (m.total_tokens / max * 100) : 0;
      return `<div class="bar-row">
        <div class="bar-label" title="${m.model}">${m.model}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,2)}%"></div></div>
        <div class="bar-value mono">${fmt(m.total_tokens)}</div>
      </div>`;
    }).join('') + '</div>';
  } catch(e) { console.error('tokens', e); }
}

async function loadToolUsage() {
  try {
    const data = await (await fetch('/api/tool-usage')).json();
    const el = document.getElementById('tool-chart');
    if (!data.length) { el.innerHTML = '<div class="loading">No tool usage data yet</div>'; return; }
    const max = Math.max(...data.map(t => t.call_count));
    el.innerHTML = '<div class="bar-chart">' + data.map(t => {
      const pct = max > 0 ? (t.call_count / max * 100) : 0;
      return `<div class="bar-row">
        <div class="bar-label" title="${t.tool_name}">${t.tool_name || 'unknown'}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,2)}%;background:var(--green)"></div></div>
        <div class="bar-value mono">${fmt(t.call_count)}</div>
      </div>`;
    }).join('') + '</div>';
  } catch(e) { console.error('tools', e); }
}

async function loadPlatformStats() {
  try {
    const data = await (await fetch('/api/platform-stats')).json();
    const platforms = new Set([
      ...Object.keys(data.users || {}),
      ...Object.keys(data.conversations || {}),
      ...Object.keys(data.messages || {}),
    ]);
    const body = document.getElementById('platform-body');
    if (!platforms.size) { body.innerHTML = '<tr><td colspan="4" class="loading">No data</td></tr>'; return; }
    body.innerHTML = [...platforms].map(p => `
      <tr><td>${platformTag(p)}</td>
      <td class="text-right mono">${fmt(data.users[p] || 0)}</td>
      <td class="text-right mono">${fmt(data.conversations[p] || 0)}</td>
      <td class="text-right mono">${fmt(data.messages[p] || 0)}</td></tr>
    `).join('');
  } catch(e) { console.error('platform', e); }
}

async function loadPersonas() {
  try {
    const data = await (await fetch('/api/personas')).json();
    const body = document.getElementById('persona-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="4" class="loading">No personas</td></tr>'; return; }
    body.innerHTML = data.map(p => `
      <tr><td><strong>${p.name}</strong></td>
      <td>${p.platform ? platformTag(p.platform) : '<span class="text-dim">global</span>'}</td>
      <td class="text-right mono">${fmt(p.total_conversations)}</td>
      <td>${p.is_default ? '<span class="tag tag-healthy">default</span>' : ''}</td></tr>
    `).join('');
  } catch(e) { console.error('personas', e); }
}

async function loadUsers() {
  try {
    const data = await (await fetch('/api/users')).json();
    document.getElementById('user-count').textContent = data.length;
    const body = document.getElementById('users-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="9" class="loading">No users</td></tr>'; return; }
    body.innerHTML = data.map(u => {
      const name = u.platforms.length
        ? u.platforms.map(p => p.platform_username || p.platform_user_id).join(', ')
        : u.id.slice(0, 8);
      const plats = u.platforms.map(p => platformTag(p.platform)).join(' ');
      const budget = u.token_budget_monthly;
      const used = u.tokens_used_this_month;
      const pct = budget ? Math.min(Math.round(used / budget * 100), 100) : null;
      const budgetHtml = budget == null
        ? '<span class="text-dim">unlimited</span>'
        : `<div class="budget-bar">
             <div class="budget-track"><div class="budget-fill" style="width:${pct}%;background:${pctColor(pct)}"></div></div>
             <div class="budget-pct">${pct}%</div>
           </div>`;
      return `<tr>
        <td><strong>${name}</strong></td>
        <td>${plats}</td>
        <td>${roleTag(u.permission_level)}</td>
        <td class="text-right mono">${fmt(used)}</td>
        <td>${budgetHtml}</td>
        <td class="text-right mono">${fmt(u.total_tokens_all_time)}</td>
        <td class="text-right mono">${fmtCost(u.total_cost_all_time)}</td>
        <td class="text-right mono">${fmt(u.total_conversations)}</td>
        <td class="text-dim">${fmtDate(u.created_at)}</td>
      </tr>`;
    }).join('');
  } catch(e) { console.error('users', e); }
}

async function loadConversations() {
  try {
    const data = await (await fetch('/api/conversations')).json();
    const body = document.getElementById('convs-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="7" class="loading">No conversations</td></tr>'; return; }
    body.innerHTML = data.map(c => `
      <tr>
        <td><strong>${c.username || c.user_id.slice(0,8)}</strong></td>
        <td>${platformTag(c.platform)}</td>
        <td class="text-right mono">${fmt(c.message_count)}</td>
        <td class="text-right mono">${fmt(c.tool_calls)}</td>
        <td class="text-dim">${fmtDate(c.started_at)}</td>
        <td class="text-dim">${fmtDate(c.last_active_at)}</td>
        <td>${c.is_summarized ? '<span class="tag tag-healthy">yes</span>' : ''}</td>
      </tr>
    `).join('');
  } catch(e) { console.error('convos', e); }
}

function loadAll() {
  loadOverview();
  loadHealth();
  loadTokenUsage();
  loadToolUsage();
  loadPlatformStats();
  loadPersonas();
  loadUsers();
  loadConversations();
}

loadAll();
// Auto-refresh every 30 seconds
setInterval(loadAll, 30000);
</script>
</body>
</html>
