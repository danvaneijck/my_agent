<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus Admin Dashboard</title>

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

<!-- Inter Font -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

<style>
  :root {
    /* Dark mode colors (default) */
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3346;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --accent: #6366f1;
    --green: #4ade80;
    --yellow: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
  }

  html.light {
    /* Light mode colors */
    --bg: #f9fafb;
    --surface: #ffffff;
    --surface2: #f3f4f6;
    --border: #e5e7eb;
    --text: #111827;
    --text-dim: #6b7280;
    --accent: #6366f1;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --orange: #f97316;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.5;
  }
  .header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header .refresh { background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .header .refresh:hover { background: var(--border); }
  .container { max-width: 1280px; margin: 0 auto; padding: 20px; }

  /* Stats cards */
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px; margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px;
  }
  .stat-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card .value { font-size: 26px; font-weight: 700; margin-top: 4px; }
  .stat-card .sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

  /* Sections */
  .section { margin-bottom: 24px; }
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .section-header h2 { font-size: 16px; font-weight: 600; }
  .section-header .badge {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 2px 10px; border-radius: 12px; font-size: 12px; color: var(--text-dim);
  }

  /* Tables */
  .table-wrap {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    overflow: hidden;
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 14px; background: var(--surface2);
    color: var(--text-dim); font-weight: 500; font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 10px 14px; border-top: 1px solid var(--border); }
  tr:hover td { background: var(--surface2); }

  /* Tags */
  .tag {
    display: inline-block; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 500;
  }
  .tag-owner { background: #6c8cff22; color: var(--accent); }
  .tag-admin { background: #fbbf2422; color: var(--yellow); }
  .tag-user { background: #4ade8022; color: var(--green); }
  .tag-guest { background: #8b90a022; color: var(--text-dim); }

  .tag-healthy { background: #4ade8022; color: var(--green); }
  .tag-unhealthy { background: #f8717122; color: var(--red); }
  .tag-unreachable { background: #8b90a022; color: var(--text-dim); }

  .tag-discord { background: #5865f222; color: #7289da; }
  .tag-telegram { background: #229ed922; color: #29b6f6; }
  .tag-slack { background: #4a154b22; color: #e01e5a; }
  .tag-web { background: #6c8cff22; color: #6c8cff; }
  .tag-google { background: #4285f422; color: #4285f4; }

  /* Two column layout */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  /* Bar chart */
  .bar-chart { padding: 16px; }
  .bar-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
  .bar-label { width: 160px; font-size: 12px; color: var(--text-dim); text-align: right;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0; }
  .bar-track { flex: 1; height: 22px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; background: var(--accent);
    display: flex; align-items: center; padding: 0 8px; font-size: 11px;
    font-weight: 500; min-width: fit-content; transition: width 0.4s ease; }
  .bar-value { width: 70px; font-size: 12px; text-align: right; flex-shrink: 0; }

  /* Tool usage groups */
  .tool-group-header { cursor: pointer; }
  .tool-group-header:hover .bar-label { color: var(--text); }
  .tool-group-header .expand-icon { display: inline-block; width: 12px; font-size: 10px; color: var(--text-dim); }
  .tool-group-detail { display: none; margin-bottom: 4px; }
  .tool-group.expanded .tool-group-detail { display: block; }
  .tool-group.expanded .expand-icon { transform: rotate(90deg); }

  /* Login gate */
  .login-gate {
    display: flex; align-items: center; justify-content: center;
    min-height: 80vh; flex-direction: column; gap: 16px;
  }
  .login-gate input {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    padding: 10px 16px; border-radius: 8px; font-size: 14px; width: 300px;
    font-family: inherit;
  }
  .login-gate input:focus { outline: none; border-color: var(--accent); }
  .login-gate button {
    background: var(--accent); color: #fff; border: none; padding: 10px 24px;
    border-radius: 8px; cursor: pointer; font-size: 14px; font-family: inherit;
  }
  .login-gate button:hover { opacity: 0.9; }
  .login-error { color: var(--red); font-size: 13px; display: none; }
  .app-content { display: none; }
  .app-content.visible { display: block; }

  /* Loading */
  .loading { text-align: center; padding: 40px; color: var(--text-dim); }
  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
  .text-right { text-align: right; }
  .text-dim { color: var(--text-dim); }

  /* Progress bar for budget */
  .budget-bar { display: flex; align-items: center; gap: 8px; }
  .budget-track { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; }
  .budget-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .budget-pct { font-size: 11px; color: var(--text-dim); width: 36px; text-align: right; }

  /* Light mode overrides for tag badges — dark-mode alpha values become near-invisible on white */
  html.light .tag-owner    { background: rgba(99,102,241,0.12); }
  html.light .tag-admin    { background: rgba(234,179,8,0.12); }
  html.light .tag-user     { background: rgba(34,197,94,0.12); }
  html.light .tag-guest    { background: rgba(107,114,128,0.12); }
  html.light .tag-healthy  { background: rgba(34,197,94,0.12); }
  html.light .tag-unhealthy   { background: rgba(239,68,68,0.12); }
  html.light .tag-unreachable { background: rgba(107,114,128,0.12); }
  html.light .tag-discord  { background: rgba(88,101,242,0.12); }
  html.light .tag-telegram { background: rgba(34,158,217,0.12); }
  html.light .tag-slack    { background: rgba(224,30,90,0.12); }
  html.light .tag-web      { background: rgba(108,140,255,0.12); }
  html.light .tag-google   { background: rgba(66,133,244,0.12); }

  /* Light mode overrides for platform tag text — hardcoded mid-tone colors fail contrast on white */
  html.light .tag-discord  { color: #4752c4; }
  html.light .tag-telegram { color: #0277bd; }
  html.light .tag-slack    { color: #b5103c; }
  html.light .tag-web      { color: #4338ca; }
  html.light .tag-google   { color: #1557b0; }

  /* Theme toggle */
  .theme-toggle {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 6px 10px; border-radius: 6px;
    cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;
    transition: all 0.2s;
  }
  .theme-toggle:hover { background: var(--border); }
  .theme-icon { width: 16px; height: 16px; }
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:12px">
    <img src="/logo-icon.svg" alt="Nexus" style="height:24px;width:24px">
    <h1>Nexus Admin Dashboard</h1>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
      <svg class="theme-icon" id="theme-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
    </button>
    <a href="/admin" style="color:var(--text-dim);text-decoration:none;font-size:13px;padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--surface2)">Admin Portal</a>
    <button class="refresh" onclick="loadAll()">Refresh</button>
  </div>
</div>

<!-- Login Gate -->
<div class="login-gate" id="login-gate">
  <h2>Admin Dashboard</h2>
  <p style="color:var(--text-dim);font-size:13px">Enter your admin API key to continue</p>
  <input type="password" id="admin-key-input" placeholder="Admin API Key" onkeydown="if(event.key==='Enter')doLogin()">
  <button onclick="doLogin()">Login</button>
  <div class="login-error" id="login-error"></div>
</div>

<div class="app-content" id="app-content">
<div class="container">
  <!-- Overview Stats -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card"><div class="label">Loading...</div></div>
  </div>

  <!-- System Health -->
  <div class="section">
    <div class="section-header"><h2>System Health</h2></div>
    <div class="table-wrap">
      <table><thead><tr>
        <th>Service</th><th>Status</th><th>Details</th>
      </tr></thead><tbody id="health-body"><tr><td colspan="3" class="loading">Loading...</td></tr></tbody></table>
    </div>
  </div>

  <div class="two-col">
    <!-- Token Usage by Model -->
    <div class="section">
      <div class="section-header"><h2>Tokens by Model</h2><span class="badge">Last 30 days</span></div>
      <div class="table-wrap" id="model-chart"><div class="loading">Loading...</div></div>
    </div>

    <!-- Tool Usage -->
    <div class="section">
      <div class="section-header"><h2>Tool Usage</h2></div>
      <div class="table-wrap" id="tool-chart"><div class="loading">Loading...</div></div>
    </div>
  </div>

  <div class="two-col">
    <!-- Platform Stats -->
    <div class="section">
      <div class="section-header"><h2>Platform Breakdown</h2></div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Platform</th><th class="text-right">Users</th><th class="text-right">Conversations</th><th class="text-right">Messages</th>
        </tr></thead><tbody id="platform-body"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Personas -->
    <div class="section">
      <div class="section-header"><h2>Personas</h2></div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Name</th><th>Platform</th><th class="text-right">Conversations</th><th>Default</th>
        </tr></thead><tbody id="persona-body"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="section">
    <div class="section-header"><h2>Users</h2><span class="badge" id="user-count">-</span></div>
    <div class="table-wrap">
      <table><thead><tr>
        <th>User</th><th>Platform</th><th>Role</th>
        <th class="text-right">Tokens (Month)</th><th>Budget Usage</th>
        <th class="text-right">Total Tokens</th><th class="text-right">Est. Cost</th>
        <th class="text-right">Convos</th><th>Joined</th>
      </tr></thead><tbody id="users-body"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody></table>
    </div>
  </div>

  <!-- Recent Conversations -->
  <div class="section">
    <div class="section-header"><h2>Recent Conversations</h2><span class="badge">Last 50</span></div>
    <div class="table-wrap">
      <table><thead><tr>
        <th>User</th><th>Platform</th><th class="text-right">Messages</th>
        <th class="text-right">Tool Calls</th><th>Started</th><th>Last Active</th><th>Summarized</th>
      </tr></thead><tbody id="convs-body"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody></table>
    </div>
  </div>
</div>
</div><!-- /app-content -->

<script>
// Theme management (synced with portal)
function getTheme() {
  return localStorage.getItem('theme') || 'dark';
}

function setTheme(newTheme) {
  localStorage.setItem('theme', newTheme);
  applyTheme(newTheme);
}

function applyTheme(theme) {
  const html = document.documentElement;
  const icon = document.getElementById('theme-icon');

  if (theme === 'light') {
    html.classList.add('light');
    if (icon) {
      // Sun icon for light mode
      icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
    }
  } else {
    html.classList.remove('light');
    if (icon) {
      // Moon icon for dark mode
      icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
    }
  }
}

function toggleTheme() {
  const currentTheme = getTheme();
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  setTheme(newTheme);
}

// Initialize theme on page load
applyTheme(getTheme());

// --- Auth ---
function getAdminKey() { return sessionStorage.getItem('admin_api_key') || ''; }

function showApp() {
  document.getElementById('login-gate').style.display = 'none';
  document.getElementById('app-content').classList.add('visible');
}

function showLogin() {
  document.getElementById('login-gate').style.display = 'flex';
  document.getElementById('app-content').classList.remove('visible');
}

async function doLogin() {
  const key = document.getElementById('admin-key-input').value.trim();
  if (!key) return;
  try {
    const resp = await fetch('/api/overview', { headers: {'X-Admin-Key': key} });
    if (resp.ok) {
      sessionStorage.setItem('admin_api_key', key);
      document.getElementById('login-error').style.display = 'none';
      showApp();
      loadAll();
    } else {
      document.getElementById('login-error').textContent = 'Invalid admin key';
      document.getElementById('login-error').style.display = 'block';
    }
  } catch(e) {
    document.getElementById('login-error').textContent = 'Connection error';
    document.getElementById('login-error').style.display = 'block';
  }
}

function authHeaders() {
  return {'X-Admin-Key': getAdminKey()};
}

const fmt = (n) => n == null ? '-' : Number(n).toLocaleString();
const fmtCost = (n) => n == null ? '-' : '$' + Number(n).toFixed(4);
const fmtDate = (iso) => {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
         d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
};
const pctColor = (pct) => pct > 90 ? 'var(--red)' : pct > 70 ? 'var(--yellow)' : 'var(--green)';
const platformTag = (p) => `<span class="tag tag-${p}">${p}</span>`;
const roleTag = (r) => `<span class="tag tag-${r}">${r}</span>`;
const healthTag = (s) => `<span class="tag tag-${s}">${s}</span>`;

async function loadOverview() {
  try {
    const data = await (await fetch('/api/overview', {headers: authHeaders()})).json();
    document.getElementById('stats-grid').innerHTML = `
      <div class="stat-card"><div class="label">Users</div><div class="value">${fmt(data.total_users)}</div></div>
      <div class="stat-card"><div class="label">Conversations</div><div class="value">${fmt(data.total_conversations)}</div>
        <div class="sub">${fmt(data.active_conversations_24h)} active (24h)</div></div>
      <div class="stat-card"><div class="label">Messages</div><div class="value">${fmt(data.total_messages)}</div></div>
      <div class="stat-card"><div class="label">Total Tokens</div><div class="value">${fmt(data.total_tokens)}</div>
        <div class="sub">${fmt(data.tokens_7d)} last 7 days</div></div>
      <div class="stat-card"><div class="label">Est. Cost</div><div class="value">${fmtCost(data.total_cost)}</div>
        <div class="sub">${fmtCost(data.cost_7d)} last 7 days</div></div>
      <div class="stat-card"><div class="label">Memories</div><div class="value">${fmt(data.total_memories)}</div></div>
      <div class="stat-card"><div class="label">Files</div><div class="value">${fmt(data.total_files)}</div></div>
    `;
  } catch(e) { console.error('overview', e); }
}

async function loadHealth() {
  try {
    const data = await (await fetch('/api/system-health', {headers: authHeaders()})).json();
    const body = document.getElementById('health-body');
    body.innerHTML = Object.entries(data).map(([name, info]) => `
      <tr><td><strong>${name}</strong></td>
      <td>${healthTag(info.status)}</td>
      <td class="text-dim mono">${info.error || (info.status_code ? 'HTTP ' + info.status_code : 'OK')}</td></tr>
    `).join('');
  } catch(e) { console.error('health', e); }
}

async function loadTokenUsage() {
  try {
    const data = await (await fetch('/api/token-usage', {headers: authHeaders()})).json();
    const el = document.getElementById('model-chart');
    if (!data.by_model.length) { el.innerHTML = '<div class="loading">No token usage data yet</div>'; return; }
    const max = Math.max(...data.by_model.map(m => m.total_tokens));
    el.innerHTML = '<div class="bar-chart">' + data.by_model.map(m => {
      const pct = max > 0 ? (m.total_tokens / max * 100) : 0;
      return `<div class="bar-row">
        <div class="bar-label" title="${m.model}">${m.model}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,2)}%"></div></div>
        <div class="bar-value mono">${fmt(m.total_tokens)}</div>
      </div>`;
    }).join('') + '</div>';
  } catch(e) { console.error('tokens', e); }
}

async function loadToolUsage() {
  try {
    const data = await (await fetch('/api/tool-usage', {headers: authHeaders()})).json();
    const el = document.getElementById('tool-chart');
    if (!data.length) { el.innerHTML = '<div class="loading">No tool usage data yet</div>'; return; }

    // Group by module (prefix before the dot)
    const modules = {};
    data.forEach(t => {
      const parts = (t.tool_name || 'unknown').split('.');
      const mod = parts.length > 1 ? parts[0] : 'other';
      if (!modules[mod]) modules[mod] = { total: 0, tools: [] };
      modules[mod].total += t.call_count;
      modules[mod].tools.push(t);
    });

    const sorted = Object.entries(modules).sort((a, b) => b[1].total - a[1].total);
    const max = Math.max(...sorted.map(([, m]) => m.total));

    el.innerHTML = '<div class="bar-chart">' + sorted.map(([mod, info]) => {
      const pct = max > 0 ? (info.total / max * 100) : 0;
      const toolMax = Math.max(...info.tools.map(t => t.call_count));
      const toolBars = info.tools.sort((a, b) => b.call_count - a.call_count).map(t => {
        const tPct = toolMax > 0 ? (t.call_count / toolMax * 100) : 0;
        const name = t.tool_name?.split('.').pop() || 'unknown';
        return `<div class="bar-row" style="padding-left:20px">
          <div class="bar-label" style="width:140px;font-size:11px" title="${t.tool_name}">${name}</div>
          <div class="bar-track" style="height:18px"><div class="bar-fill" style="width:${Math.max(tPct,2)}%;background:var(--accent);opacity:0.7"></div></div>
          <div class="bar-value mono" style="font-size:11px">${fmt(t.call_count)}</div>
        </div>`;
      }).join('');
      return `<div class="tool-group">
        <div class="bar-row tool-group-header" onclick="this.parentElement.classList.toggle('expanded')">
          <div class="bar-label"><span class="expand-icon">&#9656;</span> ${mod}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,2)}%;background:var(--green)">${info.tools.length > 1 ? '<span style="color:#111827;opacity:0.8;font-size:10px">' + info.tools.length + ' tools</span>' : ''}</div></div>
          <div class="bar-value mono">${fmt(info.total)}</div>
        </div>
        <div class="tool-group-detail">${toolBars}</div>
      </div>`;
    }).join('') + '</div>';
  } catch(e) { console.error('tools', e); }
}

async function loadPlatformStats() {
  try {
    const data = await (await fetch('/api/platform-stats', {headers: authHeaders()})).json();
    const platforms = new Set([
      ...Object.keys(data.users || {}),
      ...Object.keys(data.conversations || {}),
      ...Object.keys(data.messages || {}),
    ]);
    const body = document.getElementById('platform-body');
    if (!platforms.size) { body.innerHTML = '<tr><td colspan="4" class="loading">No data</td></tr>'; return; }
    body.innerHTML = [...platforms].map(p => `
      <tr><td>${platformTag(p)}</td>
      <td class="text-right mono">${fmt(data.users[p] || 0)}</td>
      <td class="text-right mono">${fmt(data.conversations[p] || 0)}</td>
      <td class="text-right mono">${fmt(data.messages[p] || 0)}</td></tr>
    `).join('');
  } catch(e) { console.error('platform', e); }
}

async function loadPersonas() {
  try {
    const data = await (await fetch('/api/personas', {headers: authHeaders()})).json();
    const body = document.getElementById('persona-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="4" class="loading">No personas</td></tr>'; return; }
    body.innerHTML = data.map(p => `
      <tr><td><strong>${p.name}</strong></td>
      <td>${p.platform ? platformTag(p.platform) : '<span class="text-dim">global</span>'}</td>
      <td class="text-right mono">${fmt(p.total_conversations)}</td>
      <td>${p.is_default ? '<span class="tag tag-healthy">default</span>' : ''}</td></tr>
    `).join('');
  } catch(e) { console.error('personas', e); }
}

async function loadUsers() {
  try {
    const data = await (await fetch('/api/users', {headers: authHeaders()})).json();
    document.getElementById('user-count').textContent = data.length;
    const body = document.getElementById('users-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="9" class="loading">No users</td></tr>'; return; }
    body.innerHTML = data.map(u => {
      const name = u.platforms.length
        ? u.platforms.map(p => p.platform_username || p.platform_user_id).join(', ')
        : u.id.slice(0, 8);
      const plats = u.platforms.map(p => platformTag(p.platform)).join(' ');
      const budget = u.token_budget_monthly;
      const used = u.tokens_used_this_month;
      const pct = budget ? Math.min(Math.round(used / budget * 100), 100) : null;
      const budgetHtml = budget == null
        ? '<span class="text-dim">unlimited</span>'
        : `<div class="budget-bar">
             <div class="budget-track"><div class="budget-fill" style="width:${pct}%;background:${pctColor(pct)}"></div></div>
             <div class="budget-pct">${pct}%</div>
           </div>`;
      return `<tr>
        <td><strong>${name}</strong></td>
        <td>${plats}</td>
        <td>${roleTag(u.permission_level)}</td>
        <td class="text-right mono">${fmt(used)}</td>
        <td>${budgetHtml}</td>
        <td class="text-right mono">${fmt(u.total_tokens_all_time)}</td>
        <td class="text-right mono">${fmtCost(u.total_cost_all_time)}</td>
        <td class="text-right mono">${fmt(u.total_conversations)}</td>
        <td class="text-dim">${fmtDate(u.created_at)}</td>
      </tr>`;
    }).join('');
  } catch(e) { console.error('users', e); }
}

async function loadConversations() {
  try {
    const data = await (await fetch('/api/conversations', {headers: authHeaders()})).json();
    const body = document.getElementById('convs-body');
    if (!data.length) { body.innerHTML = '<tr><td colspan="7" class="loading">No conversations</td></tr>'; return; }
    body.innerHTML = data.map(c => `
      <tr>
        <td><strong>${c.username || c.user_id.slice(0,8)}</strong></td>
        <td>${platformTag(c.platform)}</td>
        <td class="text-right mono">${fmt(c.message_count)}</td>
        <td class="text-right mono">${fmt(c.tool_calls)}</td>
        <td class="text-dim">${fmtDate(c.started_at)}</td>
        <td class="text-dim">${fmtDate(c.last_active_at)}</td>
        <td>${c.is_summarized ? '<span class="tag tag-healthy">yes</span>' : ''}</td>
      </tr>
    `).join('');
  } catch(e) { console.error('convos', e); }
}

function loadAll() {
  loadOverview();
  loadHealth();
  loadTokenUsage();
  loadToolUsage();
  loadPlatformStats();
  loadPersonas();
  loadUsers();
  loadConversations();
}

// Auto-login if key exists in session
if (getAdminKey()) {
  showApp();
  loadAll();
} else {
  showLogin();
}
// Auto-refresh every 30 seconds (only if authenticated)
setInterval(() => { if (getAdminKey()) loadAll(); }, 30000);
</script>
</body>
</html>
