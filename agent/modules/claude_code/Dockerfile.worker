FROM node:20-bookworm

# =============================================================
# System packages — single layer for cache efficiency
# =============================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
        # --- Existing essentials ---
        git \
        openssh-client \
        ripgrep \
        jq \
        build-essential \
        python3 \
        python3-pip \
        python3-venv \
        python3-dev \
        curl \
        ca-certificates \
        sudo \
        #
        # --- Build tools & compilers ---
        cmake \
        autoconf \
        automake \
        libtool \
        pkg-config \
        patch \
        xz-utils \
        gfortran \
        #
        # --- Database CLI clients ---
        postgresql-client \
        sqlite3 \
        default-mysql-client \
        redis-tools \
        #
        # --- Native npm package deps (sharp, canvas, pg-native, sqlite3) ---
        libvips-dev \
        libcairo2-dev \
        libpango1.0-dev \
        libgif-dev \
        librsvg2-dev \
        libpq-dev \
        libsqlite3-dev \
        #
        # --- Image/media format libs (Pillow, sharp) ---
        libjpeg-dev \
        libpng-dev \
        libtiff-dev \
        libwebp-dev \
        libfreetype6-dev \
        liblcms2-dev \
        libharfbuzz-dev \
        #
        # --- Math / science (numpy, scipy, scikit-learn) ---
        libopenblas-dev \
        liblapack-dev \
        libhdf5-dev \
        #
        # --- System / crypto / compression libs ---
        libssl-dev \
        libffi-dev \
        libbz2-dev \
        liblzma-dev \
        zlib1g-dev \
        libxml2-dev \
        libxslt1-dev \
        libyaml-dev \
        libreadline-dev \
        libncursesw5-dev \
        libcurl4-openssl-dev \
        libglib2.0-dev \
        #
        # --- Media tools ---
        ffmpeg \
        imagemagick \
        #
        # --- Network & debugging ---
        wget \
        netcat-openbsd \
        dnsutils \
        iproute2 \
        iputils-ping \
        htop \
        lsof \
        #
        # --- File & text tools ---
        tree \
        zip \
        unzip \
        less \
        #
        # --- Language runtimes from apt ---
        ruby-full \
        php-cli \
        default-jdk-headless \
        #
        # --- Version control ---
        git-lfs \
    && rm -rf /var/lib/apt/lists/*

# =============================================================
# GitHub CLI
# =============================================================
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] \
        https://cli.github.com/packages stable main" \
        > /etc/apt/sources.list.d/github-cli.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends gh \
    && rm -rf /var/lib/apt/lists/*

# =============================================================
# Go
# =============================================================
ENV GOLANG_VERSION=1.23.4
RUN curl -fsSL "https://go.dev/dl/go${GOLANG_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tar.gz \
    && tar -C /usr/local -xzf /tmp/go.tar.gz \
    && rm /tmp/go.tar.gz
ENV GOPATH=/home/claude/go
ENV PATH=$PATH:/usr/local/go/bin:$GOPATH/bin

# =============================================================
# Rust (minimal profile — ~300 MB)
# =============================================================
ENV RUSTUP_HOME=/usr/local/rustup
ENV CARGO_HOME=/usr/local/cargo
ENV PATH=$CARGO_HOME/bin:$PATH
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- \
    -y --no-modify-path --profile minimal --default-toolchain stable

# =============================================================
# Bun
# =============================================================
RUN curl -fsSL https://bun.sh/install | BUN_INSTALL=/usr/local bash \
    && ln -sf /usr/local/bin/bun /usr/local/bin/bunx

# =============================================================
# Deno
# =============================================================
RUN curl -fsSL https://deno.land/install.sh | DENO_INSTALL=/usr/local sh

# =============================================================
# Claude Code CLI
# =============================================================
RUN npm install -g @anthropic-ai/claude-code

# Create non-root user (claude CLI refuses --dangerously-skip-permissions as root)
# Grant passwordless sudo so Claude Code can install tools at runtime
# (the container is disposable and isolated, so this is safe)
RUN useradd -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/claude

# Pre-populate SSH known_hosts for common Git hosts
RUN mkdir -p /home/claude/.ssh && \
    ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> /home/claude/.ssh/known_hosts 2>/dev/null && \
    ssh-keyscan -t rsa,ecdsa,ed25519 bitbucket.org >> /home/claude/.ssh/known_hosts 2>/dev/null && \
    chown -R claude:claude /home/claude/.ssh && \
    chmod 600 /home/claude/.ssh/known_hosts

WORKDIR /workspace
RUN chown claude:claude /workspace

# Entrypoint runs as root to copy credentials, then drops to claude user
CMD ["claude"]
